'use client';

import React, { createContext, useState, useContext, ReactNode, useEffect, useRef } from 'react';
import { Modal } from './modal';
import { Button } from './button';
import { Input } from './input';
import { Calendar, Clock, Stethoscope, Pill, FileText, Users, CalendarPlus, PlusCircle, User, Phone, Mail, Heart, PencilIcon, FileCheck2, Trash2, Printer, Download, CheckCircle, AlertTriangle, Search } from 'lucide-react';
import { AppointmentsTab, VitalsTab, PrescriptionsTab, LabsTab, NotesTab } from '@/components/patients/tabs';
import { useSession } from 'next-auth/react';

// Modal types for our application
type ModalType = 
  | 'newAppointment'
  | 'newPrescription'
  | 'addPatient'
  | 'addMedication'
  | 'viewCalendar'
  | 'viewPatientDetails'
  | 'patientActions'
  | 'processPayment'
  | 'appointmentPayment'
  | 'viewInvoice';

// We need to define a fixed interface for UnpaidAppointment to avoid errors
interface UnpaidAppointment {
  id: string;
  patientName: string;
  patientId: string;
  date: string;
  type: string;
  amount: number;
  provider: string;
}

interface ModalContextType {
  openModal: (type: ModalType | { title: string; content: React.ReactNode; size?: string }, data?: any) => void;
  closeModal: () => void;
}

export const ModalContext = createContext<ModalContextType | undefined>(undefined);

export function useModal() {
  const context = useContext(ModalContext);
  if (context === undefined) {
    throw new Error('useModal must be used within a ModalProvider');
  }
  return context;
}

interface ModalProviderProps {
  children: ReactNode;
}

// Define medication type
interface Medication {
  name: string;
  dosage: string;
  frequency: string;
  duration: string;
  instructions: string;
  refills: number;
}

// NewPrescriptionModal component
function NewPrescriptionModal({ isOpen, onClose, initialData }: { isOpen: boolean, onClose: () => void, initialData?: any }) {
  const [loading, setLoading] = useState(false);
  const modalContext = useContext(ModalContext);
  
  // Check if we need to return to patient view when closing
  const shouldReturnToPatient = initialData?.returnToPatient;
  const [patients, setPatients] = useState<any[]>([]);
  const [medications, setMedications] = useState<any[]>([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedMedications, setSelectedMedications] = useState<Medication[]>([]);
  const [formData, setFormData] = useState({
    patient: '',
    diagnosis: '',
    notes: '',
    status: 'Active'
  });
  
  // Fetch patients when component mounts
  useEffect(() => {
    const fetchPatients = async () => {
      try {
        const response = await fetch('/api/patients');
        if (!response.ok) throw new Error('Failed to fetch patients');
        const data = await response.json();
        setPatients(data.patients);
        
        // If initialData contains a patientId, pre-select the patient
        if (initialData && initialData.patientId) {
          setFormData(prevData => ({
            ...prevData,
            patient: initialData.patientId
          }));
        }
      } catch (error) {
        console.error('Error fetching patients:', error);
      }
    };
    
    if (isOpen) {
      fetchPatients();
    }
  }, [isOpen, initialData]);
  
  // Search for medications
  useEffect(() => {
    if (searchQuery.length > 2) {
      const searchMedications = async () => {
        try {
          const response = await fetch(`/api/medications/search?q=${searchQuery}`);
          if (!response.ok) throw new Error('Failed to search medications');
          const data = await response.json();
          setMedications(data.medications);
        } catch (error) {
          console.error('Error searching medications:', error);
        }
      };
      
      searchMedications();
    } else {
      setMedications([]);
    }
  }, [searchQuery]);
  
  const handleChange = (e: any) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };
  
  const handleMedicationSearch = (e: any) => {
    setSearchQuery(e.target.value);
  };
  
  const selectMedication = (medication: any) => {
    setSelectedMedications(prev => [...prev, {
      name: medication.name,
      dosage: '',
      frequency: 'Once daily',
      duration: '30 days',
      instructions: '',
      refills: 0
    }]);
    setSearchQuery('');
    setMedications([]);
  };
  
  const updateMedication = (index: number, field: string, value: string | number) => {
    setSelectedMedications(prev => prev.map((med, i) => 
      i === index ? { ...med, [field]: value } : med
    ));
  };
  
  const removeMedication = (index: number) => {
    setSelectedMedications(prev => prev.filter((_, i) => i !== index));
  };
  
  const handleSubmit = async () => {
    try {
      setLoading(true);
      
      // Validate required fields
      if (!formData.patient || selectedMedications.length === 0) {
        alert('Please select a patient and at least one medication');
        setLoading(false);
        return;
      }
      
      // Validate medication fields
      for (const med of selectedMedications) {
        if (!med.dosage || !med.frequency || !med.duration) {
          alert('Please fill all required medication fields');
          setLoading(false);
          return;
        }
      }
      
      // Submit the prescription
      const response = await fetch('/api/prescriptions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          ...formData,
          medications: selectedMedications
        })
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to create prescription');
      }
      
      // Reset form and close modal
      setFormData({
        patient: '',
        diagnosis: '',
        notes: '',
        status: 'Active'
      });
      setSelectedMedications([]);
      onClose();
    } catch (error) {
      console.error('Error creating prescription:', error);
      alert(error.message);
    } finally {
      setLoading(false);
    }
  };
  
  const handleCancel = () => {
    if (shouldReturnToPatient && initialData && modalContext) {
      // First close this modal
      onClose();
      
      // Then open the patient details modal
      setTimeout(() => {
        modalContext.openModal('viewPatientDetails', initialData);
      }, 10);
    } else {
      // Just close the modal
      onClose();
    }
  };
  
  if (!isOpen) return null;
  
    return (
    <Modal 
      isOpen={isOpen} 
      onClose={onClose}
      title="New Prescription"
      footer={
        <>
          <Button 
            variant="outline" 
            onClick={handleCancel} 
            disabled={loading}
          >
            Cancel
          </Button>
          <Button variant="primary" onClick={handleSubmit} disabled={loading}>
            {loading ? 'Creating...' : 'Create Prescription'}
          </Button>
        </>
      }
    >
      <div className="space-y-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Patient
          </label>
          <select 
            className="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200"
            name="patient"
            value={formData.patient}
            onChange={handleChange}
          >
            <option value="">Select a patient</option>
            {patients.map((patient: any) => (
              <option key={patient._id} value={patient._id}>
                {patient.name} ({patient.patientId})
              </option>
            ))}
          </select>
        </div>
        
        <div>
          <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Diagnosis
          </label>
          <Input 
            type="text"
            placeholder="Enter diagnosis"
            name="diagnosis"
            value={formData.diagnosis}
            onChange={handleChange}
          />
        </div>
        
        <div>
          <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Search Medications
          </label>
          <Input 
            type="text" 
            placeholder="Type to search medications"
            value={searchQuery}
            onChange={handleMedicationSearch}
          />
          
          {medications.length > 0 && (
            <div className="mt-1 border border-gray-200 rounded-md max-h-40 overflow-y-auto dark:border-gray-700">
              {medications.map((med: any) => (
                <div 
                  key={med._id} 
                  className="p-2 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer"
                  onClick={() => selectMedication(med)}
                >
                  <div className="font-medium">{med.name}</div>
                  <div className="text-xs text-gray-500 dark:text-gray-400">
                    {med.genericName} • {med.formulation} • {med.strength}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
        
        {selectedMedications.length > 0 && (
          <div className="mt-4">
            <h3 className="font-medium text-gray-900 dark:text-white mb-2">Selected Medications</h3>
            <div className="space-y-4">
              {selectedMedications.map((med, index) => (
                <div key={index} className="p-3 border border-gray-200 dark:border-gray-700 rounded-md">
                  <div className="flex justify-between items-center mb-2">
                    <h4 className="font-medium text-gray-900 dark:text-white">{med.name}</h4>
                    <Button 
                      variant="ghost" 
                      size="sm" 
                      onClick={() => removeMedication(index)}
                    >
                      <Trash2 size={14} className="text-gray-500" />
                    </Button>
                  </div>
                  
                  <div className="grid grid-cols-2 gap-2 mb-2">
                    <div>
                      <label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">
                        Dosage
                      </label>
                      <Input 
                        type="text"
                        placeholder="e.g., 20mg"
                        value={med.dosage}
                        onChange={(e) => updateMedication(index, 'dosage', e.target.value)}
                        size={4}
                      />
                    </div>
                    <div>
                      <label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">
                        Frequency
                      </label>
                      <select 
                        className="w-full rounded-md border border-gray-300 bg-white px-2 py-1 text-xs text-gray-700 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200"
                        value={med.frequency}
                        onChange={(e) => updateMedication(index, 'frequency', e.target.value)}
                      >
                        <option value="Once daily">Once Daily</option>
                        <option value="Twice daily">Twice Daily</option>
                        <option value="Three times daily">Three Times Daily</option>
                        <option value="Four times daily">Four Times Daily</option>
                        <option value="Weekly">Weekly</option>
                        <option value="As needed">As Needed</option>
                      </select>
                    </div>
                  </div>
                  
                  <div className="grid grid-cols-2 gap-2">
                    <div>
                      <label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">
                        Duration
                      </label>
                      <Input 
                        type="text"
                        placeholder="e.g., 30 days"
                        value={med.duration}
                        onChange={(e) => updateMedication(index, 'duration', e.target.value)}
                        size={4}
                      />
                    </div>
                    <div>
                      <label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">
                        Refills
                      </label>
                      <Input 
                        type="number"
                        placeholder="0"
                        value={med.refills.toString()}
                        onChange={(e) => updateMedication(index, 'refills', parseInt(e.target.value) || 0)}
                        size={4}
                      />
                    </div>
                  </div>
                  
                  <div className="mt-2">
                    <label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">
                      Instructions
                    </label>
                    <textarea 
                      className="w-full rounded-md border border-gray-300 bg-white px-2 py-1 text-xs text-gray-700 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200"
                      rows={2}
                      placeholder="Enter special instructions"
                      value={med.instructions}
                      onChange={(e) => updateMedication(index, 'instructions', e.target.value)}
                    ></textarea>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}
        
        <div>
          <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Notes
          </label>
          <textarea 
            className="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200"
            rows={3}
            placeholder="Enter notes"
            name="notes"
            value={formData.notes}
            onChange={handleChange}
          ></textarea>
        </div>
      </div>
    </Modal>
  );
}

export function ModalProvider({ children }: ModalProviderProps) {
  const [isOpen, setIsOpen] = useState(false);
  const [modalType, setModalType] = useState<ModalType | null>(null);
  const [customModal, setCustomModal] = useState<{ title: string; content: React.ReactNode; size?: string } | null>(null);
  const [modalData, setModalData] = useState<any>(null);
  
  // Modal functions - declare them here before using in refs
  const openModal = (type: ModalType | { title: string; content: React.ReactNode; size?: string }, data?: any) => {
    if (typeof type === 'object') {
      setCustomModal(type);
      setModalType(null);
    } else {
      setModalType(type);
      setCustomModal(null);
    }
    setModalData(data);
    setIsOpen(true);
  };

  const closeModal = () => {
    setIsOpen(false);
    setModalType(null);
    setModalData(null);
    setCustomModal(null);
  };
  
  // The ref to store modal functions for access from outside the provider
  const modalContextRef = useRef({ openModal, closeModal });
  
  // Update the ref whenever the functions change
  useEffect(() => {
    modalContextRef.current = { openModal, closeModal };
  }, []);
  
  // States for Add Patient Modal
  const [addPatientLoading, setAddPatientLoading] = useState(false);
  const [addPatientFormData, setAddPatientFormData] = useState({
    name: '',
    email: '',
    phone: '',
    dob: '',
    gender: '',
    address: '',
    city: '',
    state: '',
    zip: '',
    insurance: '',
    policyNumber: '',
    emergencyContact: '',
    emergencyPhone: '',
    allergens: '',
    medicalHistory: ''
  });
  
  // States for Add Medication Modal
  const [addMedicationLoading, setAddMedicationLoading] = useState(false);
  const [addMedicationFormData, setAddMedicationFormData] = useState({
    name: '',
    generic_name: '',
    dosage: '',
    formulation: 'Tablet',
    manufacturer: '',
    category: '',
    description: '',
    usage: '',
    side_effects: '',
    contraindications: '',
    price: '',
    quantity: '0'
  });
  
  // States for New Appointment Modal
  const [newAppointmentLoading, setNewAppointmentLoading] = useState(false);
  const [newAppointmentFormData, setNewAppointmentFormData] = useState({
    patient: '',
    date: '',
    time: '',
    type: 'Follow-up',
    duration: '30 min',
    reason: ''
  });
  const [newAppointmentPatients, setNewAppointmentPatients] = useState([]);
  const [newAppointmentTimeSlots, setNewAppointmentTimeSlots] = useState([]);
  const [newAppointmentIsWorkingDay, setNewAppointmentIsWorkingDay] = useState(true);
  
  // States for Patient Details Modal
  const [activeTab, setActiveTab] = useState('overview');
  
  // States for View Calendar Modal
  const [calendarCurrentDate, setCalendarCurrentDate] = useState(new Date());
  const [calendarView, setCalendarView] = useState('month');

  const { data: session } = useSession();
  
  // Effects for New Appointment Modal
  useEffect(() => {
    if (modalType === 'newAppointment') {
      const fetchPatients = async () => {
        try {
          const response = await fetch('/api/patients');
          if (!response.ok) throw new Error('Failed to fetch patients');
          const data = await response.json();
          setNewAppointmentPatients(data.patients || []);
          
          // Auto-select the patient if patientId is provided in modalData
          if (modalData && modalData.patientId) {
            setNewAppointmentFormData(prev => ({
              ...prev,
              patient: modalData.patientId
            }));
          }
        } catch (error) {
          console.error('Error fetching patients:', error);
          setNewAppointmentPatients([]);
        }
      };
      
      fetchPatients();
    }
  }, [modalType, modalData]);
  
  useEffect(() => {
    if (modalType === 'newAppointment' && newAppointmentFormData.date) {
      const checkWorkingDay = async () => {
        try {
          // Get schedule settings from localStorage
          let scheduleSettings = null;
          try {
            const savedSettings = localStorage.getItem('scheduleSettings');
            if (savedSettings) {
              scheduleSettings = JSON.parse(savedSettings);
              console.log('Using saved schedule settings for time slots:', scheduleSettings);
            } else {
              console.log('No saved schedule settings found in localStorage');
              // Use default settings if none found
              scheduleSettings = {
                startTime: '08:30 AM',
                endTime: '05:00 PM',
                interval: 30,
                workDays: [0, 1, 2, 3, 4, 5, 6], // All days
                lunchBreak: {
                  start: '12:30 PM',
                  end: '01:30 PM',
                  enabled: true
                }
              };
            }
          } catch (error) {
            console.error('Error parsing saved schedule settings:', error);
            
            // Fallback to default settings
            scheduleSettings = {
              startTime: '08:30 AM',
              endTime: '05:00 PM',
              interval: 30,
              workDays: [0, 1, 2, 3, 4, 5, 6], // All days
              lunchBreak: {
                start: '12:30 PM',
                end: '01:30 PM',
                enabled: true
              }
            };
          }
          
          // Check if selected date is a working day
          const selectedDate = new Date(newAppointmentFormData.date);
          const dayOfWeek = selectedDate.getDay();
          
          // Use settings from localStorage if available, otherwise use default assumption
          const workDays = scheduleSettings?.workDays || [0, 1, 2, 3, 4, 5, 6]; // Default: All days
          const isWorkingDay = workDays.includes(dayOfWeek);
          setNewAppointmentIsWorkingDay(isWorkingDay);
          
          if (!isWorkingDay) {
            console.log(`Day ${dayOfWeek} is not a working day according to settings:`, workDays);
            setNewAppointmentTimeSlots([]);
            return;
          }
          
          // Generate basic time slots directly in the client as a fallback
          const fallbackTimeSlots = generateBasicTimeSlots(scheduleSettings);
          
          // Fetch available time slots from the API
          const params = new URLSearchParams({
            date: newAppointmentFormData.date
          });
          
          // Add settings to the query
          params.append('settings', JSON.stringify(scheduleSettings));
          
          console.log(`Fetching time slots for date: ${newAppointmentFormData.date}`);
          
          const response = await fetch(`/api/appointments/timeslots?${params.toString()}`);
          
          if (!response.ok) {
            console.error('API error fetching time slots:', response.status, response.statusText);
            // Use fallback slots if API fails
            console.log('Using fallback time slots:', fallbackTimeSlots);
            setNewAppointmentTimeSlots(fallbackTimeSlots);
            return;
          }
          
          const data = await response.json();
          console.log('Received time slots from API:', data);
          
          if (data.availableSlots && data.availableSlots.length > 0) {
            setNewAppointmentTimeSlots(data.availableSlots);
          } else {
            // If the API returns empty slots but we know it's a working day, use fallback
            console.log('API returned no time slots. Using fallback slots:', fallbackTimeSlots);
            setNewAppointmentTimeSlots(fallbackTimeSlots);
          }
        } catch (error) {
          console.error('Error checking working day:', error);
          setNewAppointmentIsWorkingDay(true);
          setNewAppointmentTimeSlots([]);
        }
      };
      
      // Simple helper to generate time slots as a fallback
      const generateBasicTimeSlots = (settings) => {
        const slots = [];
        const startTime = settings?.startTime || '08:30 AM';
        const endTime = settings?.endTime || '05:00 PM';
        const interval = settings?.interval || 30;
        
        // Convert to minutes since midnight
        const toMinutes = (timeStr) => {
          const [time, modifier] = timeStr.split(' ');
          let [hours, minutes] = time.split(':').map(Number);
          if (modifier === 'PM' && hours < 12) hours += 12;
          if (modifier === 'AM' && hours === 12) hours = 0;
          return hours * 60 + minutes;
        };
        
        // Convert minutes back to time string
        const toTimeString = (minutes) => {
          const hours = Math.floor(minutes / 60);
          const mins = minutes % 60;
          const period = hours >= 12 ? 'PM' : 'AM';
          const displayHours = hours % 12 || 12;
          return `${displayHours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')} ${period}`;
        };
        
        const startMinutes = toMinutes(startTime);
        const endMinutes = toMinutes(endTime);
        
        // Skip lunch break if configured
        const lunchBreak = settings?.lunchBreak;
        const lunchStartMin = lunchBreak && lunchBreak.enabled ? toMinutes(lunchBreak.start) : -1;
        const lunchEndMin = lunchBreak && lunchBreak.enabled ? toMinutes(lunchBreak.end) : -1;
        
        for (let i = startMinutes; i < endMinutes; i += interval) {
          // Skip lunch break
          if (lunchBreak && lunchBreak.enabled && i >= lunchStartMin && i < lunchEndMin) {
            continue;
          }
          slots.push(toTimeString(i));
        }
        
        return slots;
      };
      
      checkWorkingDay();
    }
  }, [modalType, newAppointmentFormData.date]);
  
  const openModal = (type: ModalType | { title: string; content: React.ReactNode; size?: string }, data?: any) => {
    if (typeof type === 'object') {
      setCustomModal(type);
      setModalType(null);
    } else {
      setModalType(type);
      setCustomModal(null);
    }
    setModalData(data);
    setIsOpen(true);
  };

  const closeModal = () => {
    setIsOpen(false);
    setModalType(null);
    setModalData(null);
    setCustomModal(null);
  };

  // New Appointment Modal
  const renderNewAppointmentModal = () => {
    // Skip rendering content if modal is not active
    if (modalType !== 'newAppointment') {
      return null;
    }
    
    // Check if we need to return to patient view when closing
    const shouldReturnToPatient = modalData?.returnToPatient;
    
    // Function to generate default time slots when API fails
    const generateDefaultTimeSlots = () => {
      console.log('Generating default time slots as fallback');
      const slots = [];
      // Standard business hours 8:00 AM to 5:00 PM
      const startHour = 8;
      const endHour = 17;
      const interval = 30; // minutes
      
      for (let hour = startHour; hour < endHour; hour++) {
        for (let minute = 0; minute < 60; minute += interval) {
          const period = hour >= 12 ? 'PM' : 'AM';
          const displayHour = hour % 12 || 12;
          const displayMinute = minute.toString().padStart(2, '0');
          slots.push(`${displayHour.toString().padStart(2, '0')}:${displayMinute} ${period}`);
        }
      }
      
      console.log('Generated fallback slots:', slots);
      return slots;
    };
    
    const handleChange = (e: any) => {
      const { name, value } = e.target;
      setNewAppointmentFormData(prev => ({ ...prev, [name]: value }));
    };
    
    const handleSubmit = async () => {
      try {
        setNewAppointmentLoading(true);
        
        // Validate form data
        if (!newAppointmentFormData.patient || !newAppointmentFormData.date || !newAppointmentFormData.time) {
          alert('Please fill in all required fields');
          setNewAppointmentLoading(false);
          return;
        }
        
        // Submit appointment data
        const response = await fetch('/api/appointments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(newAppointmentFormData)
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to schedule appointment');
        }
        
        // Reset form and close modal
        setNewAppointmentFormData({
          patient: '',
          date: '',
          time: '',
          type: 'Follow-up',
          duration: '30 min',
          reason: ''
        });
        
        // Dispatch a custom event to notify that an appointment was created
        const appointmentCreatedEvent = new CustomEvent('appointment-created', {
          detail: { appointment: await response.json() }
        });
        window.dispatchEvent(appointmentCreatedEvent);
        
        closeModal();
      } catch (error) {
        console.error('Error scheduling appointment:', error);
        alert(error.message);
      } finally {
        setNewAppointmentLoading(false);
      }
    };
    
    return (
      <Modal 
        isOpen={modalType === 'newAppointment'} 
        onClose={closeModal}
        title="New Appointment"
        footer={
          <>
            <Button 
              variant="outline" 
              onClick={() => {
                if (shouldReturnToPatient && modalData) {
                  // Return to the patient view modal
                  openModal('viewPatientDetails', modalData);
                } else {
                  // Just close the modal
                  closeModal();
                }
              }} 
              disabled={newAppointmentLoading}
            >
              Cancel
            </Button>
            <Button variant="primary" onClick={handleSubmit} disabled={newAppointmentLoading}>
              {newAppointmentLoading ? 'Scheduling...' : 'Schedule Appointment'}
            </Button>
          </>
        }
      >
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Patient
            </label>
            <select 
              className="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200"
              name="patient"
              value={newAppointmentFormData.patient}
              onChange={handleChange}
            >
              <option value="">Select a patient</option>
              {newAppointmentPatients.map((patient: any) => (
                <option key={patient._id} value={patient._id}>
                  {patient.name} ({patient.patientId})
                </option>
              ))}
            </select>
          </div>
          
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Date
              </label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <Calendar size={16} className="text-gray-400" />
                </div>
                <Input 
                  type="date"
                  className="pl-10"
                  name="date"
                  value={newAppointmentFormData.date}
                  onChange={handleChange}
                />
              </div>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Time
              </label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <Clock size={16} className="text-gray-400" />
                </div>
                {newAppointmentIsWorkingDay ? (
                  <>
                    <select
                      className="w-full rounded-md border border-gray-300 bg-white pl-10 py-2 text-sm text-gray-700 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200"
                      name="time"
                      value={newAppointmentFormData.time}
                      onChange={handleChange}
                    >
                      <option value="">Select an available time</option>
                      {newAppointmentTimeSlots.length > 0 ? (
                        newAppointmentTimeSlots.map((slot: string) => {
                          // Convert to 24-hour format for value
                          const [time, period] = slot.split(' ');
                          let [hours, minutes] = time.split(':').map(Number);
                          if (period === 'PM' && hours < 12) hours += 12;
                          if (period === 'AM' && hours === 12) hours = 0;
                          const value = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                          
                          return (
                            <option key={slot} value={value}>
                              {slot}
                            </option>
                          );
                        })
                      ) : (
                        // Generate default slots if none available
                        generateDefaultTimeSlots().map((slot: string) => {
                          // Convert to 24-hour format for value
                          const [time, period] = slot.split(' ');
                          let [hours, minutes] = time.split(':').map(Number);
                          if (period === 'PM' && hours < 12) hours += 12;
                          if (period === 'AM' && hours === 12) hours = 0;
                          const value = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                          
                          return (
                            <option key={slot} value={value}>
                              {slot}
                            </option>
                          );
                        })
                      )}
                    </select>
                    <div className="mt-1 flex justify-between">
                      <button 
                        type="button"
                        onClick={() => {
                          if (newAppointmentFormData.date) {
                            // Directly generate default time slots as a backup
                            if (newAppointmentTimeSlots.length === 0) {
                              setNewAppointmentTimeSlots(generateDefaultTimeSlots());
                            } else {
                              // Re-trigger the checkWorkingDay function by re-setting the date
                              setNewAppointmentFormData(prev => ({
                                ...prev,
                                date: prev.date
                              }));
                            }
                          }
                        }}
                        className="text-xs text-primary-600 dark:text-primary-400 hover:underline ml-auto"
                      >
                        ↻ Reload Time Slots
                      </button>
                    </div>
                  </>
                ) : (
                  <div className="w-full rounded-md border border-gray-300 bg-gray-50 pl-10 py-2 text-sm text-gray-500 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-400">
                    No appointments available on this day
                  </div>
                )}
              </div>
            </div>
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Appointment Type
            </label>
            <select 
              className="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200"
              name="type"
              value={newAppointmentFormData.type}
              onChange={handleChange}
            >
              <option value="Follow-up">Follow-up</option>
              <option value="Consultation">Consultation</option>
              <option value="Annual physical">Annual Physical</option>
              <option value="Specialty">Specialty Visit</option>
              <option value="Emergency">Urgent Care</option>
            </select>
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Duration
            </label>
            <select 
              className="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200"
              name="duration"
              value={newAppointmentFormData.duration}
              onChange={handleChange}
            >
              <option value="15 min">15 minutes</option>
              <option value="30 min">30 minutes</option>
              <option value="45 min">45 minutes</option>
              <option value="60 min">60 minutes</option>
            </select>
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Reason for Visit
            </label>
            <textarea 
              className="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200"
              rows={3}
              placeholder="Enter reason for visit"
              name="reason"
              value={newAppointmentFormData.reason}
              onChange={handleChange}
            ></textarea>
          </div>
        </div>
      </Modal>
    );
  };

  // Add Patient Modal
  const renderAddPatientModal = () => {
    // Skip rendering content if modal is not active
    if (modalType !== 'addPatient') {
      return null;
    }
    
    // Check if we need to return to patient view when closing
    const shouldReturnToPatient = modalData?.returnToPatient;
    
    const handleChange = (e: any) => {
      const { name, value } = e.target;
      setAddPatientFormData(prev => ({ ...prev, [name]: value }));
    };
    
    const handleSubmit = async () => {
      try {
        setAddPatientLoading(true);
        
        // Validate required fields
        if (!addPatientFormData.name || !addPatientFormData.email || !addPatientFormData.phone || !addPatientFormData.dob || !addPatientFormData.gender || !addPatientFormData.address || !addPatientFormData.city || !addPatientFormData.state || !addPatientFormData.zip || !addPatientFormData.insurance || !addPatientFormData.policyNumber || !addPatientFormData.emergencyContact || !addPatientFormData.emergencyPhone || !addPatientFormData.allergens || !addPatientFormData.medicalHistory) {
          alert('Please fill all required fields');
          setAddPatientLoading(false);
          return;
        }
        
        // Process form data
        const processedData = {
          ...addPatientFormData,
          dob: new Date(addPatientFormData.dob).toISOString().split('T')[0],
          medicalHistory: addPatientFormData.medicalHistory.split(',').map(item => item.trim())
        };
        
        // Submit the patient
        const response = await fetch('/api/patients', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(processedData)
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to add patient');
        }
        
        // Reset form and close modal
        setAddPatientFormData({
          name: '',
          email: '',
          phone: '',
          dob: '',
          gender: '',
          address: '',
          city: '',
          state: '',
          zip: '',
          insurance: '',
          policyNumber: '',
          emergencyContact: '',
          emergencyPhone: '',
          allergens: '',
          medicalHistory: ''
        });
        closeModal();
      } catch (error) {
        console.error('Error adding patient:', error);
        alert(error.message);
      } finally {
        setAddPatientLoading(false);
      }
    };
    
    return (
      <Modal 
        isOpen={modalType === 'addPatient'} 
        onClose={closeModal}
        title="Add New Patient"
        footer={
          <>
            <Button 
              variant="outline" 
              onClick={() => {
                if (shouldReturnToPatient && modalData) {
                  // Return to the patient view modal
                  openModal('viewPatientDetails', modalData);
                } else {
                  // Just close the modal
                  closeModal();
                }
              }} 
              disabled={addPatientLoading}
            >
              Cancel
            </Button>
            <Button variant="primary" onClick={handleSubmit} disabled={addPatientLoading}>
              {addPatientLoading ? 'Adding...' : 'Add Patient'}
            </Button>
          </>
        }
      >
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Full Name *
            </label>
            <Input 
              type="text"
              placeholder="Enter patient's full name"
              name="name"
              value={addPatientFormData.name}
              onChange={handleChange}
              required
            />
          </div>
          
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Email *
              </label>
              <Input 
                type="email"
                placeholder="Enter email"
                name="email"
                value={addPatientFormData.email}
                onChange={handleChange}
                required
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Phone *
              </label>
              <Input 
                type="tel"
                placeholder="(555) 123-4567"
                name="phone"
                value={addPatientFormData.phone}
                onChange={handleChange}
                required
              />
            </div>
          </div>
          
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Date of Birth *
              </label>
              <Input 
                type="date"
                placeholder="MM/DD/YYYY"
                name="dob"
                value={addPatientFormData.dob}
                onChange={handleChange}
                required
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Gender *
              </label>
              <select 
                className="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200"
                name="gender"
                value={addPatientFormData.gender}
                onChange={handleChange}
                required
              >
                <option value="">Select gender</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Address
            </label>
            <Input 
              type="text"
              placeholder="Enter address"
              name="address"
              value={addPatientFormData.address}
              onChange={handleChange}
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              City
            </label>
            <Input 
              type="text"
              placeholder="Enter city"
              name="city"
              value={addPatientFormData.city}
              onChange={handleChange}
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              State
            </label>
            <Input 
              type="text"
              placeholder="Enter state"
              name="state"
              value={addPatientFormData.state}
              onChange={handleChange}
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Zip Code *
            </label>
            <Input 
              type="text"
              placeholder="Enter zip code"
              name="zip"
              value={addPatientFormData.zip}
              onChange={handleChange}
              required
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Insurance Provider
            </label>
            <Input 
              type="text"
              placeholder="Enter insurance provider"
              name="insurance"
              value={addPatientFormData.insurance}
              onChange={handleChange}
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Policy Number
            </label>
            <Input 
              type="text"
              placeholder="Enter policy number"
              name="policyNumber"
              value={addPatientFormData.policyNumber}
              onChange={handleChange}
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Emergency Contact
            </label>
            <Input 
              type="text"
              placeholder="Enter emergency contact name"
              name="emergencyContact"
              value={addPatientFormData.emergencyContact}
              onChange={handleChange}
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Emergency Phone
            </label>
            <Input 
              type="tel"
              placeholder="(555) 123-4567"
              name="emergencyPhone"
              value={addPatientFormData.emergencyPhone}
              onChange={handleChange}
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Allergens (comma separated)
            </label>
            <textarea 
              className="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200"
              rows={2}
              placeholder="E.g. Penicillin, Peanuts, Latex"
              name="allergens"
              value={addPatientFormData.allergens}
              onChange={handleChange}
            ></textarea>
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Medical History (comma separated)
            </label>
            <textarea 
              className="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200"
              rows={3}
              placeholder="E.g. Diabetes, Hypertension, Asthma"
              name="medicalHistory"
              value={addPatientFormData.medicalHistory}
              onChange={handleChange}
            ></textarea>
          </div>
        </div>
      </Modal>
    );
  };

  // Add Medication Modal
  const renderAddMedicationModal = () => {
    // Skip rendering content if modal is not active
    if (modalType !== 'addMedication') {
      return null;
    }
    
    // Check if we need to return to patient view when closing
    const shouldReturnToPatient = modalData?.returnToPatient;
    
    const handleChange = (e: any) => {
      const { name, value } = e.target;
      setAddMedicationFormData(prev => ({ ...prev, [name]: value }));
    };
    
    const handleSubmit = async () => {
      try {
        setAddMedicationLoading(true);
        
        // Validate required fields
        if (!addMedicationFormData.name || !addMedicationFormData.generic_name || !addMedicationFormData.dosage || !addMedicationFormData.formulation || !addMedicationFormData.manufacturer || !addMedicationFormData.category || !addMedicationFormData.description || !addMedicationFormData.usage || !addMedicationFormData.side_effects || !addMedicationFormData.contraindications || !addMedicationFormData.price) {
          alert('Please fill all required fields');
          setAddMedicationLoading(false);
          return;
        }
        
        // Process form data
        const processedData = {
          ...addMedicationFormData,
          side_effects: addMedicationFormData.side_effects.split(',').map(item => item.trim()),
          contraindications: addMedicationFormData.contraindications.split(',').map(item => item.trim())
        };
        
        // Submit the medication
        const response = await fetch('/api/medications', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(processedData)
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to add medication');
        }
        
        // Reset form and close modal
        setAddMedicationFormData({
          name: '',
          generic_name: '',
          dosage: '',
          formulation: 'Tablet',
          manufacturer: '',
          category: '',
          description: '',
          usage: '',
          side_effects: '',
          contraindications: '',
          price: '',
          quantity: '0'
        });
        closeModal();
      } catch (error) {
        console.error('Error adding medication:', error);
        alert(error.message);
      } finally {
        setAddMedicationLoading(false);
      }
    };
    
    return (
      <Modal 
        isOpen={modalType === 'addMedication'} 
        onClose={closeModal}
        title="Add New Medication"
        footer={
          <>
            <Button 
              variant="outline" 
              onClick={() => {
                if (shouldReturnToPatient && modalData) {
                  // Return to the patient view modal
                  openModal('viewPatientDetails', modalData);
                } else {
                  // Just close the modal
                  closeModal();
                }
              }} 
              disabled={addMedicationLoading}
            >
              Cancel
            </Button>
            <Button variant="primary" onClick={handleSubmit} disabled={addMedicationLoading}>
              {addMedicationLoading ? 'Adding...' : 'Add Medication'}
            </Button>
          </>
        }
      >
        <div className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Medication Name *
              </label>
              <Input 
                type="text"
                placeholder="Enter brand name"
                name="name"
                value={addMedicationFormData.name}
                onChange={handleChange}
                required
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Generic Name *
              </label>
              <Input 
                type="text"
                placeholder="Enter generic name"
                name="generic_name"
                value={addMedicationFormData.generic_name}
                onChange={handleChange}
                required
              />
            </div>
          </div>
          
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Dosage/Strength *
              </label>
              <Input 
                type="text"
                placeholder="e.g., 500mg, 10mg/ml"
                name="dosage"
                value={addMedicationFormData.dosage}
                onChange={handleChange}
                required
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Formulation *
              </label>
              <select 
                className="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200"
                name="formulation"
                value={addMedicationFormData.formulation}
                onChange={handleChange}
                required
              >
                <option value="Tablet">Tablet</option>
                <option value="Capsule">Capsule</option>
                <option value="Liquid">Liquid</option>
                <option value="Injection">Injection</option>
                <option value="Cream">Cream/Ointment</option>
                <option value="Patch">Patch</option>
                <option value="Inhaler">Inhaler</option>
                <option value="Drops">Drops</option>
                <option value="Suppository">Suppository</option>
                <option value="Powder">Powder</option>
              </select>
            </div>
          </div>
          
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Manufacturer *
              </label>
              <Input 
                type="text"
                placeholder="Enter manufacturer"
                name="manufacturer"
                value={addMedicationFormData.manufacturer}
                onChange={handleChange}
                required
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Category *
              </label>
              <Input 
                type="text"
                placeholder="e.g. Antibiotic, Painkiller"
                name="category"
                value={addMedicationFormData.category}
                onChange={handleChange}
                required
              />
            </div>
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Description *
            </label>
            <textarea 
              className="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200"
              rows={2}
              placeholder="Brief description of the medication"
              name="description"
              value={addMedicationFormData.description}
              onChange={handleChange}
              required
            ></textarea>
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Usage Instructions *
            </label>
            <textarea 
              className="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200"
              rows={2}
              placeholder="How to take this medication"
              name="usage"
              value={addMedicationFormData.usage}
              onChange={handleChange}
              required
            ></textarea>
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Side Effects (comma separated) *
            </label>
            <textarea 
              className="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200"
              rows={2}
              placeholder="e.g. Nausea, Drowsiness, Dizziness"
              name="side_effects"
              value={addMedicationFormData.side_effects}
              onChange={handleChange}
              required
            ></textarea>
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Contraindications (comma separated) *
            </label>
            <textarea 
              className="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200"
              rows={2}
              placeholder="e.g. Pregnancy, Liver disease, Other medications"
              name="contraindications"
              value={addMedicationFormData.contraindications}
              onChange={handleChange}
              required
            ></textarea>
          </div>
          
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Price (per unit) *
              </label>
              <Input 
                type="number"
                placeholder="Enter price"
                min="0"
                step="0.01"
                name="price"
                value={addMedicationFormData.price}
                onChange={handleChange}
                required
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Initial Quantity
              </label>
              <Input 
                type="number"
                placeholder="Enter quantity"
                min="0"
                name="quantity"
                value={addMedicationFormData.quantity}
                onChange={handleChange}
              />
            </div>
          </div>
        </div>
      </Modal>
    );
  };

  // View Calendar Modal
  const renderViewCalendarModal = () => {
    // Skip rendering content if modal is not active
    if (modalType !== 'viewCalendar') {
      return null;
    }
    
    return (
      <Modal 
        isOpen={modalType === 'viewCalendar'} 
        onClose={closeModal}
        title="Calendar View"
        footer={
          <Button variant="outline" onClick={closeModal}>Close</Button>
        }
      >
        <div className="space-y-4">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-lg font-medium">September 2023</h3>
            <div className="flex gap-2">
              <Button variant="outline" size="sm" onClick={() => {
                const newDate = new Date(calendarCurrentDate);
                newDate.setMonth(newDate.getMonth() - 1);
                setCalendarCurrentDate(newDate);
              }}>Previous</Button>
              <Button variant="outline" size="sm" onClick={() => setCalendarCurrentDate(new Date())}>Today</Button>
              <Button variant="outline" size="sm" onClick={() => {
                const newDate = new Date(calendarCurrentDate);
                newDate.setMonth(newDate.getMonth() + 1);
                setCalendarCurrentDate(newDate);
              }}>Next</Button>
            </div>
          </div>
          
          <div className="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-700 dark:text-gray-300">
            <div>Sun</div>
            <div>Mon</div>
            <div>Tue</div>
            <div>Wed</div>
            <div>Thu</div>
            <div>Fri</div>
            <div>Sat</div>
          </div>
          
          <div className="grid grid-cols-7 gap-1 text-sm">
            {Array.from({ length: 30 }, (_, i) => {
              const day = i + 1;
              const hasAppointments = [4, 7, 12, 15, 17, 21, 25, 28].includes(day);
              
              return (
                <div 
                  key={day}
                  className={`p-2 h-20 border rounded-md ${
                    day === 17 ? 'bg-primary-50 border-primary-200 dark:bg-primary-900/20 dark:border-primary-800' : 
                    'border-gray-200 dark:border-gray-700'
                  }`}
                >
                  <div className="flex justify-between items-start">
                    <span className={day === 17 ? 'font-bold text-primary-600 dark:text-primary-400' : ''}>
                      {day}
                    </span>
                    {hasAppointments && (
                      <span className="h-2 w-2 rounded-full bg-primary-500"></span>
                    )}
                  </div>
                  
                  {day === 17 && (
                    <div className="mt-1 text-[10px] bg-primary-100 dark:bg-primary-900/40 p-1 rounded text-primary-800 dark:text-primary-300">
                      <div className="truncate">9:00 Emily J.</div>
                      <div className="truncate">11:45 Sophia W.</div>
                    </div>
                  )}
                  
                  {day === 12 && (
                    <div className="mt-1 text-[10px] bg-gray-100 dark:bg-gray-800 p-1 rounded">
                      <div className="truncate">10:30 Robert S.</div>
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        </div>
      </Modal>
    );
  };

  // Patient Details Modal
  const renderPatientDetailsModal = () => {
    // Skip rendering content if modal is not active
    if (modalType !== 'viewPatientDetails') {
      return null;
    }
    
    const patient = modalData;
    
    if (!patient || !patient.name) {
      return (
        <Modal isOpen={modalType === 'viewPatientDetails'} onClose={closeModal} title="Patient Details">
          <div className="p-4 text-center">
            <p>No patient data available.</p>
          </div>
        </Modal>
      );
    }

    return (
      <Modal isOpen={modalType === 'viewPatientDetails'} onClose={closeModal} title={`Patient Details: ${patient.name}`}>
        <div className="space-y-6">
          {/* Patient Header */}
          <div className="flex items-center gap-4">
            <div className="w-16 h-16 rounded-full bg-primary-100 flex items-center justify-center text-primary-700 text-xl font-medium dark:bg-primary-900 dark:text-primary-300">
              {patient.name.split(' ').map((n: string) => n[0]).join('')}
            </div>
            <div>
              <h2 className="text-xl font-semibold text-gray-900 dark:text-white">{patient.name}</h2>
              <div className="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
                <span>{patient.age} years • {patient.gender} • {patient.bloodType}</span>
                <span className="px-2 py-0.5 rounded-full text-xs font-medium bg-primary-100 text-primary-800 dark:bg-primary-900/30 dark:text-primary-300">
                  {patient.id}
                </span>
              </div>
              <div className="mt-1 text-sm text-gray-500 dark:text-gray-400">
                Patient since: {patient.patientSince}
              </div>
            </div>
            <div className="ml-auto">
              <span 
                className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                  ${patient.status === 'Active' 
                    ? 'bg-success-100 text-success-800 dark:bg-success-800/20 dark:text-success-400' 
                    : 'bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-400'}`}
              >
                {patient.status}
              </span>
            </div>
          </div>

          {/* Tabs */}
          <div className="border-b border-gray-200 dark:border-gray-700">
            <div className="flex space-x-8">
              <button 
                className={`border-b-2 py-2 px-1 text-sm font-medium ${
                  activeTab === 'overview' 
                    ? 'border-primary-500 text-primary-600 dark:text-primary-400' 
                    : 'border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300'
                }`}
                onClick={() => setActiveTab('overview')}
              >
                Overview
              </button>
              <button 
                className={`border-b-2 py-2 px-1 text-sm font-medium ${
                  activeTab === 'appointments' 
                    ? 'border-primary-500 text-primary-600 dark:text-primary-400' 
                    : 'border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300'
                }`}
                onClick={() => setActiveTab('appointments')}
              >
                Appointments
              </button>
              <button 
                className={`border-b-2 py-2 px-1 text-sm font-medium ${
                  activeTab === 'vitals' 
                    ? 'border-primary-500 text-primary-600 dark:text-primary-400' 
                    : 'border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300'
                }`}
                onClick={() => setActiveTab('vitals')}
              >
                Vitals
              </button>
              <button 
                className={`border-b-2 py-2 px-1 text-sm font-medium ${
                  activeTab === 'medications' 
                    ? 'border-primary-500 text-primary-600 dark:text-primary-400' 
                    : 'border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300'
                }`}
                onClick={() => setActiveTab('medications')}
              >
                Prescriptions
              </button>
              <button 
                className={`border-b-2 py-2 px-1 text-sm font-medium ${
                  activeTab === 'labs' 
                    ? 'border-primary-500 text-primary-600 dark:text-primary-400' 
                    : 'border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300'
                }`}
                onClick={() => setActiveTab('labs')}
              >
                Labs
              </button>
              <button 
                className={`border-b-2 py-2 px-1 text-sm font-medium ${
                  activeTab === 'notes' 
                    ? 'border-primary-500 text-primary-600 dark:text-primary-400' 
                    : 'border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300'
                }`}
                onClick={() => setActiveTab('notes')}
              >
                Notes
              </button>
            </div>
          </div>

          {/* Tab Content */}
          {activeTab === 'overview' && (
            <div className="grid grid-cols-2 gap-6">
              <div>
                <h3 className="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Personal Information</h3>
                <div className="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 space-y-3">
                  <div className="flex items-center gap-2">
                    <User size={16} className="text-gray-400" />
                    <div className="text-sm">
                      <span className="text-gray-500 dark:text-gray-400">Date of Birth:</span>
                      <span className="ml-2 text-gray-900 dark:text-white">{patient.dob} ({patient.age} years)</span>
                    </div>
                  </div>
                  <div className="flex items-center gap-2">
                    <Phone size={16} className="text-gray-400" />
                    <div className="text-sm">
                      <span className="text-gray-500 dark:text-gray-400">Phone:</span>
                      <span className="ml-2 text-gray-900 dark:text-white">{patient.contact}</span>
                    </div>
                  </div>
                  <div className="flex items-center gap-2">
                    <Mail size={16} className="text-gray-400" />
                    <div className="text-sm">
                      <span className="text-gray-500 dark:text-gray-400">Email:</span>
                      <span className="ml-2 text-gray-900 dark:text-white">{patient.email}</span>
                    </div>
                  </div>
                </div>
              </div>

              <div>
                <h3 className="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Medical Information</h3>
                <div className="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 space-y-3">
                  <div>
                    <div className="text-sm font-medium text-gray-700 dark:text-gray-300">Primary Condition</div>
                    <div className="mt-1 flex items-center">
                      <Heart size={14} className="text-danger-500 mr-1" />
                      <span className="text-sm text-gray-900 dark:text-white">{patient.primaryCondition}</span>
                    </div>
                  </div>
                  
                  <div>
                    <div className="text-sm font-medium text-gray-700 dark:text-gray-300">Secondary Conditions</div>
                    <div className="mt-1 flex flex-wrap gap-1">
                      {patient.secondaryConditions && patient.secondaryConditions.map((condition: string, idx: number) => (
                        <span key={idx} className="text-xs bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded dark:bg-gray-700 dark:text-gray-300">
                          {condition}
                        </span>
                      ))}
                    </div>
                  </div>
                  
                  <div>
                    <div className="text-sm font-medium text-gray-700 dark:text-gray-300">Allergies</div>
                    <div className="mt-1 flex flex-wrap gap-1">
                      {patient.allergies && patient.allergies.map((allergy: string, idx: number) => (
                        <span key={idx} className="text-xs bg-warning-100 text-warning-700 px-1.5 py-0.5 rounded dark:bg-warning-900/20 dark:text-warning-400">
                          {allergy}
                        </span>
                      ))}
                    </div>
                  </div>
                  
                  <div>
                    <div className="text-sm font-medium text-gray-700 dark:text-gray-300">Blood Type</div>
                    <div className="mt-1 text-sm text-gray-900 dark:text-white">{patient.bloodType}</div>
                  </div>
                </div>
              </div>

              <div className="col-span-2">
                <h3 className="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Current Medications</h3>
                <div className="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
                  <div className="space-y-2">
                    {patient.medications && patient.medications.map((medication: string, idx: number) => (
                      <div key={idx} className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <Pill size={16} className="text-primary-500" />
                          <span className="text-sm text-gray-900 dark:text-white">{medication}</span>
                        </div>
                        <Button variant="ghost" size="sm">
                          <FileText size={14} className="text-gray-400" />
                        </Button>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              <div className="col-span-2">
                <h3 className="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Recent Appointments</h3>
                <div className="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
                  <div className="space-y-3">
                    <div className="flex items-center justify-between p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                      <div className="flex items-center gap-3">
                        <Calendar size={16} className="text-primary-500" />
                        <div>
                          <div className="text-sm font-medium text-gray-900 dark:text-white">Last Visit: {patient.lastVisit}</div>
                          <div className="text-xs text-gray-500 dark:text-gray-400">Follow-up for {patient.primaryCondition}</div>
                        </div>
                      </div>
                      <Button variant="ghost" size="sm">
                        <FileText size={14} className="text-gray-400" />
                      </Button>
                    </div>
                    <div className="flex items-center justify-between p-2 bg-primary-50 dark:bg-primary-900/10 hover:bg-primary-100 dark:hover:bg-primary-900/20 rounded-lg border border-primary-200 dark:border-primary-800/30">
                      <div className="flex items-center gap-3">
                        <Calendar size={16} className="text-primary-500" />
                        <div>
                          <div className="text-sm font-medium text-gray-900 dark:text-white">Upcoming Visit: {patient.upcomingVisit}</div>
                          <div className="text-xs text-gray-500 dark:text-gray-400">Regular check-up</div>
                        </div>
                      </div>
                      <Button variant="ghost" size="sm">
                        <PencilIcon size={14} className="text-gray-400" />
                      </Button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}
          
          {activeTab === 'appointments' && <AppointmentsTab patient={patient} />}
          {activeTab === 'vitals' && <VitalsTab patient={patient} />}
          {activeTab === 'medications' && <PrescriptionsTab patient={patient} />}
          {activeTab === 'labs' && <LabsTab patient={patient} />}
          {activeTab === 'notes' && <NotesTab patient={patient} />}
        </div>
        
        <div className="mt-6 flex justify-end gap-3">
          <Button variant="outline" onClick={closeModal}>
            Close
          </Button>
          <Button variant="outline" className="flex items-center" onClick={() => {
            // Open the appointment modal with a return path to the patient view
            openModal('newAppointment', {
              ...modalData,
              returnToPatient: true
            });
          }}>
            <Calendar size={16} className="mr-2" />
            Schedule Appointment
          </Button>
          <Button variant="primary" className="flex items-center" onClick={() => {
            // Open the prescription modal with a return path to the patient view
            openModal('newPrescription', {
              ...modalData,
              returnToPatient: true
            });
          }}>
            <FileText size={16} className="mr-2" />
            New Prescription
          </Button>
        </div>
      </Modal>
    );
  };

  // Patient Actions Menu
  const renderPatientActionsModal = () => {
    // No state hooks needed for this modal
    
    // Skip rendering content if modal is not active
    if (modalType !== 'patientActions') {
      return null;
    }
    
    const patient = modalData;
    
    if (!patient || !patient.name) {
      return (
        <Modal isOpen={modalType === 'patientActions'} onClose={closeModal} title="Patient Actions">
          <div className="p-4 text-center">
            <p>No patient data available.</p>
          </div>
        </Modal>
      );
    }

    return (
      <Modal isOpen={modalType === 'patientActions'} onClose={closeModal} title="Patient Actions">
        <div className="space-y-4">
          <div className="flex items-center gap-3 mb-4">
            <div className="w-12 h-12 rounded-full bg-primary-100 flex items-center justify-center text-primary-700 font-medium dark:bg-primary-900 dark:text-primary-300">
              {patient.name.split(' ').map((n: string) => n[0]).join('')}
            </div>
            <div>
              <div className="font-medium text-gray-900 dark:text-white">{patient.name}</div>
              <div className="text-sm text-gray-500 dark:text-gray-400">{patient.id}</div>
            </div>
          </div>

          <div className="grid grid-cols-1 gap-2">
            <Button variant="outline" className="justify-start" onClick={() => {
              closeModal();
              openModal('viewPatientDetails', patient);
            }}>
              <User size={16} className="mr-2 text-primary-500" />
              View Patient Details
            </Button>
            <Button variant="outline" className="justify-start" onClick={() => {
              closeModal();
              openModal('newAppointment', {
                ...patient,
                returnToPatient: true
              });
            }}>
              <Calendar size={16} className="mr-2 text-green-500" />
              Schedule Appointment
            </Button>
            <Button variant="outline" className="justify-start" onClick={() => {
              closeModal();
              openModal('newPrescription', {
                ...patient,
                returnToPatient: true
              });
            }}>
              <Pill size={16} className="mr-2 text-purple-500" />
              Create Prescription
            </Button>
            <Button variant="outline" className="justify-start">
              <PencilIcon size={16} className="mr-2 text-blue-500" />
              Edit Patient
            </Button>
            <Button variant="outline" className="justify-start">
              <FileText size={16} className="mr-2 text-amber-500" />
              Medical Records
            </Button>
            <Button variant="outline" className="justify-start">
              <FileCheck2 size={16} className="mr-2 text-indigo-500" />
              Lab Results
            </Button>
            <Button variant="outline" className="text-danger-500 hover:text-danger-700 hover:bg-danger-50 dark:hover:bg-danger-900/20 justify-start">
              <Trash2 size={16} className="mr-2" />
              Delete Patient
            </Button>
          </div>
        </div>

        <div className="mt-6 flex justify-end">
          <Button variant="outline" onClick={closeModal}>
            Cancel
          </Button>
        </div>
      </Modal>
    );
  };

  // Payment Processing Modal Component
  function ProcessPaymentModal({ isOpen, onClose }: { isOpen: boolean, onClose: () => void }) {
    const [selectedAppointment, setSelectedAppointment] = useState<any | null>(null);
    const [manualEntry, setManualEntry] = useState<boolean>(false);
    const [unpaidAppointments, setUnpaidAppointments] = useState<any[]>([]);
    const [searchTerm, setSearchTerm] = useState<string>('');
    const [loading, setLoading] = useState<boolean>(false);
    const [formData, setFormData] = useState({
      patient: '',
      description: '',
      amount: '',
      date: new Date().toISOString().split('T')[0],
      category: '',
      paymentMethod: 'Card',
      transactionId: '',
      cardType: '',
      lastFourDigits: '',
      notes: ''
    });
    const [submitLoading, setSubmitLoading] = useState<boolean>(false);
    const [patients, setPatients] = useState<any[]>([]);
    const [printReceipt, setPrintReceipt] = useState<boolean>(true);
    const [emailReceipt, setEmailReceipt] = useState<boolean>(false);

    // Fetch unpaid appointments when the modal opens
    useEffect(() => {
      if (isOpen) {
        fetchUnpaidAppointments();
        fetchPatients();
      }
    }, [isOpen]);

    // Debounce search and fetch from API when search term changes
    useEffect(() => {
      if (!isOpen) return;
      
      const delayDebounceFn = setTimeout(() => {
        fetchUnpaidAppointments(searchTerm);
      }, 300);
      
      return () => clearTimeout(delayDebounceFn);
    }, [searchTerm, isOpen]);

    // Handle search input change
    const handleSearchChange = (e: React.ChangeEvent<HTMLInputElement>) => {
      setSearchTerm(e.target.value);
    };

    // Fetch unpaid appointments from the API
    const fetchUnpaidAppointments = async (search = '') => {
      try {
        setLoading(true);
        const url = `/api/payments?filter=unpaid${search ? `&search=${encodeURIComponent(search)}` : ''}`;
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error('Failed to fetch unpaid appointments');
        }
        const data = await response.json();
        setUnpaidAppointments(data.unpaidAppointments || []);
      } catch (error) {
        console.error('Error fetching unpaid appointments:', error);
        // In case of error, show some sample data
        setUnpaidAppointments([
          {
            id: 'temp-1',
            appointmentId: 'APT-2350',
            patientName: 'Emily Johnson',
            patientId: 'PAT-1001',
            date: '2023-09-15',
            type: 'Follow-up',
            amount: 150.00,
            provider: 'Dr. Carter'
          },
          {
            id: 'temp-2',
            appointmentId: 'APT-2351',
            patientName: 'Robert Smith',
            patientId: 'PAT-1002',
            date: '2023-09-14',
            type: 'Consultation',
            amount: 200.00,
            provider: 'Dr. Mitchell'
          }
        ]);
      } finally {
        setLoading(false);
      }
    };

    // Fetch patients for manual entry
    const fetchPatients = async () => {
      try {
        const response = await fetch('/api/patients');
        if (!response.ok) {
          throw new Error('Failed to fetch patients');
        }
        const data = await response.json();
        setPatients(data.patients || []);
      } catch (error) {
        console.error('Error fetching patients:', error);
        setPatients([]);
      }
    };

    const selectAppointment = (appointment: any) => {
      setSelectedAppointment(appointment);
      setManualEntry(false);
    };

    const toggleManualEntry = () => {
      setManualEntry(!manualEntry);
      setSelectedAppointment(null);
      // Reset form data if toggling off manual entry
      if (manualEntry) {
        setFormData({
          ...formData,
          patient: '',
          description: '',
          amount: '',
          category: ''
        });
      }
    };

    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => {
      const { name, value } = e.target;
      setFormData({ ...formData, [name]: value });
    };

    const handleSubmitPayment = async () => {
      try {
        setSubmitLoading(true);
        
        let paymentData: any = {
          paymentMethod: formData.paymentMethod,
          notes: formData.notes,
          receiptSent: emailReceipt
        };
        
        // Prepare data based on whether it's an appointment payment or manual entry
        if (selectedAppointment) {
          paymentData = {
            ...paymentData,
            appointment: selectedAppointment.id,
            patient: selectedAppointment.patientId, // This will use patientId (PAT-XXXX format)
            amount: selectedAppointment.amount,
            description: `Payment for ${selectedAppointment.type} appointment`,
            category: 'Appointment'
          };
        } else if (manualEntry) {
          // Validate manual entry form
          if (!formData.patient || !formData.amount || !formData.description || !formData.category) {
            alert('Please fill all required fields for manual payment');
            setSubmitLoading(false);
            return;
          }
          
          paymentData = {
            ...paymentData,
            patient: formData.patient, // This is already ObjectId from dropdown selection
            amount: parseFloat(formData.amount),
            description: formData.description,
            date: formData.date,
            category: formData.category
          };
        } else {
          alert('Please select an appointment or enter manual payment details');
          setSubmitLoading(false);
          return;
        }
        
        // Add payment method specific details
        if (formData.paymentMethod === 'Card') {
          if (!formData.transactionId) {
            alert('Please enter a transaction ID for card payments');
            setSubmitLoading(false);
            return;
          }
          
          paymentData.transactionId = formData.transactionId;
          paymentData.cardType = formData.cardType;
          paymentData.lastFourDigits = formData.lastFourDigits;
        }
        
        // Submit payment to the API
        const response = await fetch('/api/payments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(paymentData)
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to process payment');
        }
        
        const result = await response.json();
        
        // Show success message and close modal
        alert('Payment processed successfully!');
        onClose();
        
      } catch (error) {
        console.error('Error processing payment:', error);
        alert(`Payment failed: ${error.message}`);
      } finally {
        setSubmitLoading(false);
      }
    };

    if (!isOpen) return null;

    return (
      <Modal 
        isOpen={isOpen} 
        onClose={onClose}
        title="Process Payment"
        footer={
          <>
            <Button variant="outline" onClick={onClose} disabled={submitLoading}>Cancel</Button>
            <Button variant="primary" onClick={handleSubmitPayment} disabled={submitLoading}>
              {submitLoading ? 'Processing...' : 'Complete Payment'}
            </Button>
          </>
        }
      >
        <div className="space-y-4">
          {/* Appointment Selection Section */}
          <div className="border rounded-md overflow-hidden dark:border-gray-700">
            <div className="bg-gray-50 dark:bg-gray-800 px-4 py-3 border-b dark:border-gray-700">
              <h3 className="text-sm font-medium text-gray-700 dark:text-gray-300">Select Unpaid Appointment or Manual Entry</h3>
            </div>
            <div className="p-4">
              {/* Search Box for Unpaid Appointments */}
              <div className="mb-4">
                <div className="relative">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <Search size={16} className="text-gray-400 dark:text-gray-500" />
                  </div>
                  <Input
                    type="text"
                    placeholder="Search by patient name, ID or appointment type..."
                    className="pl-10"
                    value={searchTerm}
                    onChange={handleSearchChange}
                  />
                </div>
              </div>
              
              {loading ? (
                <div className="text-center py-4">
                  <p className="text-gray-500 dark:text-gray-400">Loading unpaid appointments...</p>
                </div>
              ) : unpaidAppointments.length > 0 ? (
                <div className="space-y-2">
                  {unpaidAppointments.map((appointment) => (
                    <div 
                      key={appointment.id}
                      className={`p-3 border rounded-md cursor-pointer transition-colors ${
                        selectedAppointment?.id === appointment.id 
                          ? 'bg-primary-50 border-primary-200 dark:bg-primary-900/20 dark:border-primary-800/50' 
                          : 'bg-white border-gray-200 hover:border-primary-200 dark:bg-gray-900 dark:border-gray-700 dark:hover:border-primary-800/50'
                      }`}
                      onClick={() => selectAppointment(appointment)}
                    >
                      <div className="flex justify-between items-start">
                        <div>
                          <p className="font-medium text-gray-900 dark:text-white">{appointment.patientName}</p>
                          <div className="flex gap-3 mt-1 text-sm text-gray-500 dark:text-gray-400">
                            <span className="flex items-center gap-1">
                              <FileText size={14} />
                              {appointment.appointmentId}
                            </span>
                            <span className="flex items-center gap-1">
                              <Calendar size={14} />
                              {appointment.date}
                            </span>
                            <span className="flex items-center gap-1">
                              <User size={14} />
                              {appointment.provider}
                            </span>
                          </div>
                        </div>
                        <div className="text-right">
                          <span className="text-sm font-medium text-primary-600 dark:text-primary-400">${appointment.amount.toFixed(2)}</span>
                          <p className="text-xs text-gray-500 dark:text-gray-400">{appointment.type}</p>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center py-4">
                  <p className="text-gray-500 dark:text-gray-400">No unpaid appointments found</p>
                </div>
              )}

              {/* Manual entry option - Making it more distinctive */}
              <div className="mt-4 pt-4 border-t border-gray-300 dark:border-gray-600">
                <div 
                  className={`p-4 rounded-md cursor-pointer transition-colors ${
                    manualEntry 
                      ? 'bg-blue-50 border-2 border-blue-300 dark:bg-blue-900/20 dark:border-blue-800/50' 
                      : 'bg-blue-50/50 border-2 border-dashed border-blue-300 hover:bg-blue-50 dark:bg-blue-900/10 dark:border-blue-800/30 dark:hover:bg-blue-900/20'
                  }`}
                  onClick={toggleManualEntry}
                >
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 dark:bg-blue-900 dark:text-blue-300">
                      <PlusCircle size={20} />
                    </div>
                    <div>
                      <p className="font-medium text-blue-700 dark:text-blue-300">Manual Payment Entry</p>
                      <p className="text-sm text-blue-600 dark:text-blue-400 mt-0.5">
                        Process a payment not linked to an appointment
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Selected Appointment Details or Manual Entry */}
          {selectedAppointment && (
            <div className="bg-primary-50 p-4 rounded-md border border-primary-100 mb-4 dark:bg-primary-900/20 dark:border-primary-800">
              <div className="flex justify-between items-center mb-2">
                <h3 className="text-sm font-medium text-gray-700 dark:text-gray-300">Appointment Details</h3>
                <span className="bg-primary-100 text-primary-800 px-2 py-1 rounded-full text-xs font-medium dark:bg-primary-800 dark:text-primary-200">
                  {selectedAppointment.type}
                </span>
              </div>
              <div className="grid grid-cols-2 gap-2 text-sm">
                <div>
                  <p className="text-gray-500 dark:text-gray-400">Patient</p>
                  <p className="font-medium">{selectedAppointment.patientName}</p>
                </div>
                <div>
                  <p className="text-gray-500 dark:text-gray-400">Date</p>
                  <p className="font-medium">{selectedAppointment.date}</p>
                </div>
              </div>
            </div>
          )}

          {manualEntry && (
            <div className="border-2 border-blue-300 rounded-md overflow-hidden dark:border-blue-800/50">
              <div className="bg-blue-50 px-4 py-3 border-b border-blue-200 dark:bg-blue-900/20 dark:border-blue-800/30">
                <h3 className="text-base font-medium text-blue-700 dark:text-blue-300 flex items-center">
                  <PlusCircle size={18} className="mr-2" />
                  Manual Payment Details
                </h3>
              </div>
              <div className="p-4 bg-white dark:bg-gray-900">
                <div className="space-y-3">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                      Patient
                    </label>
                    <select 
                      className="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200"
                      name="patient"
                      value={formData.patient}
                      onChange={handleChange}
                    >
                      <option value="">Select patient</option>
                      {patients.map((patient) => (
                        <option key={patient._id} value={patient._id}>
                          {patient.name} ({patient.patientId})
                        </option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                      Description
                    </label>
                    <Input 
                      type="text"
                      placeholder="E.g., Lab test, Medical supplies, etc." 
                      name="description"
                      value={formData.description}
                      onChange={handleChange}
                    />
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Amount ($)
                      </label>
                      <Input 
                        type="number"
                        placeholder="0.00" 
                        name="amount"
                        value={formData.amount}
                        onChange={handleChange}
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Date
                      </label>
                      <Input 
                        type="date"
                        name="date"
                        value={formData.date}
                        onChange={handleChange}
                      />
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                      Payment Category
                    </label>
                    <select
                      className="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200"
                      name="category"
                      value={formData.category}
                      onChange={handleChange}
                    >
                      <option value="">Select payment category</option>
                      <option value="Laboratory">Laboratory</option>
                      <option value="Medical Procedure">Medical Procedure</option>
                      <option value="Medical Supplies">Medical Supplies</option>
                      <option value="Consultation Fee">Consultation Fee</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Payment Summary - Show when an appointment is selected or manual entry is active */}
          {(selectedAppointment || (manualEntry && formData.amount)) && (
            <>
              <div className="flex items-center my-4">
                <div className="flex-grow border-t border-gray-200 dark:border-gray-700"></div>
                <span className="mx-4 text-sm text-gray-500 dark:text-gray-400">Payment Information</span>
                <div className="flex-grow border-t border-gray-200 dark:border-gray-700"></div>
              </div>
              
              <div className="border rounded-md overflow-hidden dark:border-gray-700">
                <div className="bg-gray-50 dark:bg-gray-800 px-4 py-3 border-b dark:border-gray-700">
                  <h3 className="text-sm font-medium text-gray-700 dark:text-gray-300">Payment Summary</h3>
                </div>
                <div className="p-4">
                  <div className="space-y-2">
                    <div className="flex justify-between">
                      <span className="text-sm text-gray-600 dark:text-gray-400">
                        {selectedAppointment ? `${selectedAppointment.type} Fee` : formData.description || 'Service Fee'}
                      </span>
                      <span className="text-sm font-medium">
                        ${selectedAppointment ? selectedAppointment.amount.toFixed(2) : (formData.amount ? parseFloat(formData.amount).toFixed(2) : '0.00')}
                      </span>
                    </div>
                    <div className="flex justify-between pt-2 border-t border-gray-200 dark:border-gray-700">
                      <span className="text-sm font-medium">Total Amount</span>
                      <span className="text-sm font-bold">
                        ${selectedAppointment ? selectedAppointment.amount.toFixed(2) : (formData.amount ? parseFloat(formData.amount).toFixed(2) : '0.00')}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </>
          )}

          {/* Only show payment method if an appointment is selected or manual entry is active */}
          {(selectedAppointment || (manualEntry && formData.amount)) && (
            <>
              {/* Payment Method Card */}
              <div className="border rounded-md overflow-hidden dark:border-gray-700 mt-4">
                <div className="bg-gray-50 dark:bg-gray-800 px-4 py-3 border-b dark:border-gray-700">
                  <h3 className="text-sm font-medium text-gray-700 dark:text-gray-300">Payment Method</h3>
                </div>
                <div className="p-4">
                  <div className="space-y-3">
                    <div className="flex items-center">
                      <input
                        type="radio"
                        id="payment-pos"
                        name="paymentMethod"
                        value="Card"
                        checked={formData.paymentMethod === 'Card'}
                        onChange={handleChange}
                        className="h-4 w-4 text-primary-600 border-gray-300"
                      />
                      <label htmlFor="payment-pos" className="ml-2 text-sm text-gray-700 dark:text-gray-300">
                        POS Machine (Card Payment)
                      </label>
                    </div>
                    
                    <div className="flex items-center">
                      <input
                        type="radio"
                        id="payment-cash"
                        name="paymentMethod"
                        value="Cash"
                        checked={formData.paymentMethod === 'Cash'}
                        onChange={handleChange}
                        className="h-4 w-4 text-primary-600 border-gray-300"
                      />
                      <label htmlFor="payment-cash" className="ml-2 text-sm text-gray-700 dark:text-gray-300">
                        Cash
                      </label>
                    </div>
                    
                    <div className="flex items-center">
                      <input
                        type="radio"
                        id="payment-check"
                        name="paymentMethod"
                        value="Check"
                        checked={formData.paymentMethod === 'Check'}
                        onChange={handleChange}
                        className="h-4 w-4 text-primary-600 border-gray-300"
                      />
                      <label htmlFor="payment-check" className="ml-2 text-sm text-gray-700 dark:text-gray-300">
                        Check
                      </label>
                    </div>
                  </div>
                </div>
              </div>
              
              {/* POS Details Card - Only show if Card payment is selected */}
              {formData.paymentMethod === 'Card' && (
                <div className="border rounded-md overflow-hidden dark:border-gray-700 mt-4">
                  <div className="bg-gray-50 dark:bg-gray-800 px-4 py-3 border-b dark:border-gray-700">
                    <h3 className="text-sm font-medium text-gray-700 dark:text-gray-300">POS Transaction Details</h3>
                  </div>
                  <div className="p-4">
                    <div className="space-y-3">
                      <div>
                        <label className="block text-sm text-gray-600 dark:text-gray-400 mb-1">
                          Transaction ID
                        </label>
                        <Input 
                          type="text"
                          placeholder="Enter POS transaction reference ID" 
                          name="transactionId"
                          value={formData.transactionId}
                          onChange={handleChange}
                        />
                      </div>
                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <label className="block text-sm text-gray-600 dark:text-gray-400 mb-1">
                            Card Type
                          </label>
                          <select 
                            className="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200"
                            name="cardType"
                            value={formData.cardType}
                            onChange={handleChange}
                          >
                            <option value="">Select card type</option>
                            <option value="Visa">Visa</option>
                            <option value="Mastercard">Mastercard</option>
                            <option value="American Express">American Express</option>
                            <option value="Discover">Discover</option>
                            <option value="Other">Other</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm text-gray-600 dark:text-gray-400 mb-1">
                            Last 4 Digits
                          </label>
                          <Input 
                            type="text"
                            placeholder="xxxx" 
                            maxLength={4}
                            name="lastFourDigits"
                            value={formData.lastFourDigits}
                            onChange={handleChange}
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Receipt Options Card */}
              <div className="border rounded-md overflow-hidden dark:border-gray-700 mt-4">
                <div className="bg-gray-50 dark:bg-gray-800 px-4 py-3 border-b dark:border-gray-700">
                  <h3 className="text-sm font-medium text-gray-700 dark:text-gray-300">Receipt Options</h3>
                </div>
                <div className="p-4">
                  <div className="space-y-3">
                    <div className="flex items-center">
                      <input
                        type="checkbox"
                        id="print-receipt"
                        className="h-4 w-4 text-primary-600 rounded border-gray-300"
                        checked={printReceipt}
                        onChange={(e) => setPrintReceipt(e.target.checked)}
                      />
                      <label htmlFor="print-receipt" className="ml-2 text-sm text-gray-700 dark:text-gray-300">
                        Print receipt for patient
                      </label>
                    </div>
                    <div className="flex items-center">
                      <input
                        type="checkbox"
                        id="email-receipt"
                        className="h-4 w-4 text-primary-600 rounded border-gray-300"
                        checked={emailReceipt}
                        onChange={(e) => setEmailReceipt(e.target.checked)}
                      />
                      <label htmlFor="email-receipt" className="ml-2 text-sm text-gray-700 dark:text-gray-300">
                        Email receipt to patient
                      </label>
                    </div>
                  </div>
                </div>
              </div>
              
              {/* Payment Notes Card */}
              <div className="border rounded-md overflow-hidden dark:border-gray-700 mt-4">
                <div className="bg-gray-50 dark:bg-gray-800 px-4 py-3 border-b dark:border-gray-700">
                  <h3 className="text-sm font-medium text-gray-700 dark:text-gray-300">Payment Notes</h3>
                </div>
                <div className="p-4">
                  <textarea 
                    className="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200"
                    rows={2}
                    placeholder="Any additional payment notes"
                    name="notes"
                    value={formData.notes}
                    onChange={handleChange}
                  ></textarea>
                </div>
              </div>
            </>
          )}
        </div>
      </Modal>
    );
  }

  // View Invoice Modal Component
  function ViewInvoiceModal({ isOpen, onClose, initialData }: { isOpen: boolean, onClose: () => void, initialData?: any }) {
    // Define state for print mode
    const [isPrinting, setIsPrinting] = useState(false);
    
    const appointment = initialData;
    if (!isOpen || !appointment) return null;

    // Calculate invoice data
    const invoiceDate = new Date().toLocaleDateString();
    const invoiceNumber = `INV-${new Date().getFullYear()}-${appointment.id || Math.floor(Math.random() * 10000)}`;
    const appointmentFee = typeof appointment.appointmentFee === 'string' 
      ? parseFloat(appointment.appointmentFee) 
      : (appointment.type === 'Annual physical' ? 200.00 : 
         appointment.type === 'Consultation' ? 150.00 : 100.00);
    const serviceFee = appointmentFee * 0.05;
    const totalAmount = appointmentFee + serviceFee;

    // Trigger window print when print button is clicked
    const handlePrint = () => {
      // Create a new window
      const printWindow = window.open('', '_blank');
      
      if (!printWindow) {
        alert('Please allow popups for this website to print invoices');
        return;
      }
      
      // Build a simple clean HTML for printing
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
          <head>
            <title>Print Invoice - ${appointment.patientName}</title>
            <meta charset="utf-8">
            <style>
              body {
                font-family: Arial, sans-serif;
                color: #333;
                line-height: 1.5;
                margin: 0;
                padding: 20px;
              }
              .container {
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
              }
              .header {
                display: flex;
                justify-content: space-between;
                margin-bottom: 30px;
                padding-bottom: 20px;
                border-bottom: 1px solid #ddd;
              }
              h1 {
                margin: 0 0 10px 0;
                color: #222;
              }
              p {
                margin: 5px 0;
              }
              .invoice-label {
                background-color: #f0f7ff;
                color: #1a56db;
                padding: 8px 12px;
                border-radius: 4px;
                font-weight: bold;
                display: inline-block;
              }
              .details {
                display: flex;
                justify-content: space-between;
                margin-bottom: 30px;
              }
              .details > div {
                flex: 1;
              }
              h3 {
                color: #555;
                font-size: 14px;
                margin-bottom: 8px;
                text-transform: uppercase;
              }
              table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 30px;
              }
              th {
                background-color: #f9fafb;
                text-align: left;
                padding: 12px;
                border-bottom: 1px solid #ddd;
              }
              td {
                padding: 12px;
                border-bottom: 1px solid #ddd;
              }
              .text-right {
                text-align: right;
              }
              .total-row {
                background-color: #f9fafb;
                font-weight: bold;
              }
              .status {
                padding: 15px;
                margin-bottom: 20px;
                background-color: #ecfdf5;
                border: 1px solid #10b981;
                border-radius: 4px;
                color: #065f46;
              }
              .notes {
                border-top: 1px solid #ddd;
                padding-top: 20px;
                color: #666;
                font-size: 14px;
              }
              @media print {
                body {
                  -webkit-print-color-adjust: exact;
                  print-color-adjust: exact;
                }
              }
            </style>
          </head>
          <body onload="setTimeout(function() { window.print(); setTimeout(function() { window.close(); }, 500); }, 300);">
            <div class="container">
              <div class="header">
                <div>
                  <h1>DoctorCare Medical Center</h1>
                  <p>123 Medical Center Dr.</p>
                  <p>Healthville, CA 12345</p>
                  <p>(555) 123-4567</p>
                </div>
                <div style="text-align: right;">
                  <div class="invoice-label">INVOICE</div>
                  <p style="margin-top: 10px;"><strong>Invoice #:</strong> ${invoiceNumber}</p>
                  <p><strong>Date:</strong> ${invoiceDate}</p>
                  <p><strong>Due Date:</strong> ${invoiceDate}</p>
                </div>
              </div>

              <div class="details">
                <div>
                  <h3>Bill To:</h3>
                  <p><strong>${appointment.patientName}</strong></p>
                  <p>Patient ID: ${appointment.patientId}</p>
                </div>
                <div>
                  <h3>Service Details:</h3>
                  <p><strong>Type:</strong> ${appointment.type || 'Medical Service'}</p>
                  <p><strong>Date:</strong> ${appointment.dateTime || (appointment.date ? `${new Date(appointment.date).toLocaleDateString()} at ${appointment.time}` : 'N/A')}</p>
                  <p><strong>Provider:</strong> ${appointment.provider || 'Dr. John Carter'}</p>
                </div>
              </div>

              <table>
                <thead>
                  <tr>
                    <th>Description</th>
                    <th class="text-right">Amount</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>${appointment.type || 'Medical Service'} - ${appointment.dateTime || (appointment.date ? `${new Date(appointment.date).toLocaleDateString()} at ${appointment.time}` : 'Scheduled Appointment')}</td>
                    <td class="text-right">$${appointmentFee.toFixed(2)}</td>
                  </tr>
                  <tr>
                    <td>Service Fee</td>
                    <td class="text-right">$${serviceFee.toFixed(2)}</td>
                  </tr>
                  <tr class="total-row">
                    <td>Total</td>
                    <td class="text-right">$${totalAmount.toFixed(2)}</td>
                  </tr>
                </tbody>
              </table>

              <div class="status">
                <strong>✓ Payment Processed</strong>
                <span style="float: right;">Paid on ${new Date().toLocaleDateString()}</span>
              </div>

              <div class="notes">
                <p><strong>Note:</strong> Thank you for choosing DoctorCare Medical Center for your healthcare needs.</p>
                <p style="margin-top: 10px;"><strong>Payment Terms:</strong> Payment is due upon receipt of this invoice.</p>
              </div>
            </div>
          </body>
        </html>
      `);
      
      printWindow.document.close();
    };

    // Handle direct PDF download without alerts
    const handleDownload = () => {
      // Get the invoice content
      const invoiceContent = document.getElementById('invoice-printable');
      if (!invoiceContent) return;
      
      // Create a new window with optimized content
      const pdfWindow = window.open('', '_blank');
      if (!pdfWindow) {
        alert('Please allow popups to download the invoice');
        return;
      }
      
      // Write the invoice content to the new window
      pdfWindow.document.write(`
        <!DOCTYPE html>
        <html>
          <head>
            <title>Download Invoice - ${appointment.patientName}</title>
            <meta charset="utf-8">
            <style>
              body {
                font-family: Arial, sans-serif;
                color: #333;
                line-height: 1.5;
                margin: 0;
                padding: 20px;
              }
              .container {
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
              }
              .header {
                display: flex;
                justify-content: space-between;
                margin-bottom: 30px;
                padding-bottom: 20px;
                border-bottom: 1px solid #ddd;
              }
              h1 {
                margin: 0 0 10px 0;
                color: #222;
              }
              p {
                margin: 5px 0;
              }
              .invoice-label {
                background-color: #f0f7ff;
                color: #1a56db;
                padding: 8px 12px;
                border-radius: 4px;
                font-weight: bold;
                display: inline-block;
              }
              .details {
                display: flex;
                justify-content: space-between;
                margin-bottom: 30px;
              }
              .details > div {
                flex: 1;
              }
              h3 {
                color: #555;
                font-size: 14px;
                margin-bottom: 8px;
                text-transform: uppercase;
              }
              table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 30px;
              }
              th {
                background-color: #f9fafb;
                text-align: left;
                padding: 12px;
                border-bottom: 1px solid #ddd;
              }
              td {
                padding: 12px;
                border-bottom: 1px solid #ddd;
              }
              .text-right {
                text-align: right;
              }
              .total-row {
                background-color: #f9fafb;
                font-weight: bold;
              }
              .status {
                padding: 15px;
                margin-bottom: 20px;
                background-color: #ecfdf5;
                border: 1px solid #10b981;
                border-radius: 4px;
                color: #065f46;
              }
              .notes {
                border-top: 1px solid #ddd;
                padding-top: 20px;
                color: #666;
                font-size: 14px;
              }
              #loading {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(255,255,255,0.9);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 9999;
              }
              .spinner {
                border: 6px solid #f3f3f3;
                border-top: 6px solid #3498db;
                border-radius: 50%;
                width: 50px;
                height: 50px;
                animation: spin 1s linear infinite;
                margin-bottom: 15px;
              }
              @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
              }
              .download-btn {
                display: flex;
                justify-content: center;
                margin-top: 20px;
              }
              button {
                padding: 10px 20px;
                background-color: #0066cc;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
              }
              button:hover {
                background-color: #0052a3;
              }
            </style>
            <!-- Load jsPDF directly -->
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
          </head>
          <body>
            <div id="loading">
              <div class="spinner"></div>
              <p>Preparing your invoice for download...</p>
            </div>
            
            <div id="invoice" class="container">
              <div class="header">
                <div>
                  <h1>DoctorCare Medical Center</h1>
                  <p>123 Medical Center Dr.</p>
                  <p>Healthville, CA 12345</p>
                  <p>(555) 123-4567</p>
                </div>
                <div style="text-align: right;">
                  <div class="invoice-label">INVOICE</div>
                  <p style="margin-top: 10px;"><strong>Invoice #:</strong> ${invoiceNumber}</p>
                  <p><strong>Date:</strong> ${invoiceDate}</p>
                  <p><strong>Due Date:</strong> ${invoiceDate}</p>
                </div>
              </div>

              <div class="details">
                <div>
                  <h3>Bill To:</h3>
                  <p><strong>${appointment.patientName}</strong></p>
                  <p>Patient ID: ${appointment.patientId}</p>
                </div>
                <div>
                  <h3>Service Details:</h3>
                  <p><strong>Type:</strong> ${appointment.type || 'Medical Service'}</p>
                  <p><strong>Date:</strong> ${appointment.dateTime || (appointment.date ? `${new Date(appointment.date).toLocaleDateString()} at ${appointment.time}` : 'N/A')}</p>
                  <p><strong>Provider:</strong> ${appointment.provider || 'Dr. John Carter'}</p>
                </div>
              </div>

              <table>
                <thead>
                  <tr>
                    <th>Description</th>
                    <th class="text-right">Amount</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>${appointment.type || 'Medical Service'} - ${appointment.dateTime || (appointment.date ? `${new Date(appointment.date).toLocaleDateString()} at ${appointment.time}` : 'Scheduled Appointment')}</td>
                    <td class="text-right">$${appointmentFee.toFixed(2)}</td>
                  </tr>
                  <tr>
                    <td>Service Fee</td>
                    <td class="text-right">$${serviceFee.toFixed(2)}</td>
                  </tr>
                  <tr class="total-row">
                    <td>Total</td>
                    <td class="text-right">$${totalAmount.toFixed(2)}</td>
                  </tr>
                </tbody>
              </table>

              <div class="status">
                <strong>✓ Payment Processed</strong>
                <span style="float: right;">Paid on ${new Date().toLocaleDateString()}</span>
              </div>

              <div class="notes">
                <p><strong>Note:</strong> Thank you for choosing DoctorCare Medical Center for your healthcare needs.</p>
                <p style="margin-top: 10px;"><strong>Payment Terms:</strong> Payment is due upon receipt of this invoice.</p>
              </div>
              
              <div class="download-btn">
                <button onclick="downloadPDF()">Download as PDF</button>
              </div>
            </div>
            
            <script>
              // Function to generate and download PDF
              function downloadPDF() {
                const { jsPDF } = window.jspdf;
                const invoice = document.getElementById('invoice');
                
                // Remove download button before capturing
                const downloadBtn = document.querySelector('.download-btn');
                if (downloadBtn) {
                  downloadBtn.style.display = 'none';
                }
                
                // Generate PDF
                window.html2canvas(invoice, {
                  scale: 2,
                  useCORS: true,
                  logging: false,
                  backgroundColor: '#ffffff'
                }).then(canvas => {
                  const imgData = canvas.toDataURL('image/png');
                  const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                  });
                  
                  const imgWidth = 210; // A4 width in mm
                  const pageHeight = 297; // A4 height in mm
                  const imgHeight = canvas.height * imgWidth / canvas.width;
                  
                  pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                  
                  // Handle multi-page
                  if (imgHeight > pageHeight) {
                    let heightLeft = imgHeight - pageHeight;
                    let position = -pageHeight;
                    
                    while (heightLeft > 0) {
                      position = position - pageHeight;
                      pdf.addPage();
                      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                      heightLeft -= pageHeight;
                    }
                  }
                  
                  // Download the PDF
                  pdf.save('Invoice-${appointment.patientName?.replace(/\s+/g, '-')}-${invoiceNumber}.pdf');
                  
                  // Close the window after download
                  setTimeout(() => {
                    window.close();
                  }, 500);
                });
              }
              
              // Auto-download after page loads
              window.onload = function() {
                setTimeout(downloadPDF, 1000);
              };
            </script>
          </body>
        </html>
      `);
      
      pdfWindow.document.close();
    };

    // Use useEffect to check if we need to automatically trigger an action
    useEffect(() => {
      // Check if there's an action flag in the appointment data
      if (appointment.action === 'print') {
        // Trigger print after a short delay to ensure the modal is rendered
        const timer = setTimeout(() => {
          handlePrint();
        }, 300);
        return () => clearTimeout(timer);
      } else if (appointment.action === 'download') {
        // Trigger download after a short delay to ensure the modal is rendered
        const timer = setTimeout(() => {
          handleDownload();
        }, 300);
        return () => clearTimeout(timer);
      }
    }, [isOpen, appointment]);

    return (
      <Modal 
        isOpen={isOpen} 
        onClose={onClose}
        title="Appointment Invoice"
        footer={
          <>
            <Button variant="outline" onClick={onClose}>Close</Button>
            <Button variant="outline" onClick={handlePrint}>
              <Printer size={16} className="mr-2" />
              Print Invoice
            </Button>
            <Button variant="primary" onClick={handleDownload}>
              <Download size={16} className="mr-2" />
              Download PDF
            </Button>
          </>
        }
      >
        <div className="space-y-6 print:p-6 print-container" id="invoice-printable">
          {/* Invoice Header */}
          <div className="flex justify-between items-start border-b border-gray-200 dark:border-gray-700 pb-4 print:mt-0">
            <div>
              <h2 className="text-xl font-bold text-gray-900 dark:text-white print:text-black">DoctorCare Medical Center</h2>
              <p className="text-sm text-gray-500 dark:text-gray-400 print:text-gray-700">123 Medical Center Dr.</p>
              <p className="text-sm text-gray-500 dark:text-gray-400 print:text-gray-700">Healthville, CA 12345</p>
              <p className="text-sm text-gray-500 dark:text-gray-400 print:text-gray-700">(555) 123-4567</p>
            </div>
            <div className="text-right">
              <div className="bg-primary-100 text-primary-800 font-bold px-3 py-1 rounded dark:bg-primary-900/30 dark:text-primary-300 print:bg-blue-100 print:text-blue-800">
                INVOICE
              </div>
              <p className="text-sm text-gray-500 dark:text-gray-400 print:text-gray-700 mt-2">Invoice #: {invoiceNumber}</p>
              <p className="text-sm text-gray-500 dark:text-gray-400 print:text-gray-700">Date: {invoiceDate}</p>
              <p className="text-sm text-gray-500 dark:text-gray-400 print:text-gray-700">Due Date: {invoiceDate}</p>
            </div>
          </div>

          {/* Invoice To */}
          <div className="grid grid-cols-2 gap-6">
            <div>
              <h3 className="text-sm font-medium text-gray-900 dark:text-gray-100 print:text-gray-900 mb-2">Bill To:</h3>
              <p className="text-sm text-gray-800 dark:text-gray-300 print:text-gray-800 font-medium">{appointment.patientName}</p>
              <p className="text-sm text-gray-500 dark:text-gray-400 print:text-gray-600">Patient ID: {appointment.patientId}</p>
            </div>
            <div>
              <h3 className="text-sm font-medium text-gray-900 dark:text-gray-100 print:text-gray-900 mb-2">Service Details:</h3>
              <p className="text-sm text-gray-800 dark:text-gray-300 print:text-gray-800">Appointment Type: <span className="font-medium">{appointment.type || 'Medical Service'}</span></p>
              <p className="text-sm text-gray-800 dark:text-gray-300 print:text-gray-800">Date: <span className="font-medium">{appointment.dateTime || (appointment.date ? `${new Date(appointment.date).toLocaleDateString()} at ${appointment.time}` : 'N/A')}</span></p>
              <p className="text-sm text-gray-800 dark:text-gray-300 print:text-gray-800">Provider: <span className="font-medium">{appointment.provider || 'Dr. John Carter'}</span></p>
            </div>
          </div>

          {/* Invoice Items */}
          <div className="border rounded-md overflow-hidden dark:border-gray-700 print:border-gray-300">
            <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700 print:divide-gray-300">
              <thead className="bg-gray-50 dark:bg-gray-800 print:bg-gray-100">
                <tr>
                  <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400 print:text-gray-700">
                    Description
                  </th>
                  <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400 print:text-gray-700">
                    Amount
                  </th>
                </tr>
              </thead>
              <tbody className="bg-white dark:bg-gray-900 print:bg-white divide-y divide-gray-200 dark:divide-gray-700 print:divide-gray-200">
                <tr>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 print:text-gray-800">
                    {appointment.type || 'Medical Service'} - {appointment.dateTime || (appointment.date ? `${new Date(appointment.date).toLocaleDateString()} at ${appointment.time}` : 'Scheduled Appointment')}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right dark:text-gray-300 print:text-gray-800">
                    ${appointmentFee.toFixed(2)}
                  </td>
                </tr>
                <tr>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 print:text-gray-800">
                    Service Fee
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right dark:text-gray-300 print:text-gray-800">
                    ${serviceFee.toFixed(2)}
                  </td>
                </tr>
                <tr className="bg-gray-50 dark:bg-gray-800 print:bg-gray-100">
                  <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white print:text-gray-900">
                    Total
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm font-bold text-primary-600 text-right dark:text-primary-400 print:text-blue-800">
                    ${totalAmount.toFixed(2)}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          {/* Payment Status */}
          <div className="flex items-center justify-between bg-green-50 p-4 rounded-md border border-green-200 dark:bg-green-900/20 dark:border-green-700/30 print:bg-green-50 print:border-green-300">
            <div className="flex items-center gap-2">
              <CheckCircle className="text-green-500 print:text-green-600" size={20} />
              <span className="font-medium text-green-800 dark:text-green-400 print:text-green-800">Payment Processed</span>
            </div>
            <span className="text-sm text-green-600 dark:text-green-400 print:text-green-700">
              Paid on {new Date().toLocaleDateString()}
            </span>
          </div>

          {/* Notes & Terms */}
          <div className="text-sm text-gray-500 dark:text-gray-400 print:text-gray-600 border-t border-gray-200 dark:border-gray-700 print:border-gray-300 pt-4">
            <p><span className="font-medium">Note:</span> Thank you for choosing DoctorCare Medical Center for your healthcare needs.</p>
            <p className="mt-2"><span className="font-medium">Payment Terms:</span> Payment is due upon receipt of this invoice.</p>
          </div>
        </div>

        {/* Print Styles */}
        <style jsx global>{`
          /* PDF generation spinner */
          .pdf-generating {
            position: relative;
          }
          .pdf-loader-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
          }
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
          
          @media print {
            @page {
              size: portrait;
              margin: 10mm;
            }
            
            html, body {
              width: 210mm; /* A4 width */
              height: 297mm; /* A4 height */
              margin: 0 !important;
              padding: 0 !important;
              overflow: hidden !important;
              background-color: white !important;
              -webkit-print-color-adjust: exact !important;
              print-color-adjust: exact !important;
            }
            
            *, *::before, *::after {
              box-shadow: none !important;
              text-shadow: none !important;
            }
            
            body * {
              visibility: hidden !important;
              display: none !important;
            }
            
            .modal-overlay {
              display: none !important;
            }
            
            .modal, .modal-content, .modal-content * {
              visibility: hidden !important;
              display: none !important;
            }
            
            #invoice-printable {
              visibility: visible !important;
              display: block !important;
              position: absolute !important;
              left: 0 !important;
              top: 0 !important;
              width: 100% !important;
              height: auto !important;
              background-color: white !important;
              padding: 20px !important;
              margin: 0 !important;
            }
            
            #invoice-printable * {
              visibility: visible !important;
              display: revert !important;
            }
            
            /* Hide UI elements when printing */
            .modal-backdrop, 
            .modal-footer, 
            .modal-header, 
            #pdf-loader,
            button,
            [role="dialog"] {
              display: none !important;
            }
            
            /* Fix for content appearing twice */
            body > *:not(:first-child) {
              display: none !important;
            }
          }
        `}</style>
      </Modal>
    );
  }

  // Appointment Payment Modal Component - dedicated modal for the appointment page $ button
  function AppointmentPaymentModal({ isOpen, onClose, initialData }: { isOpen: boolean, onClose: () => void, initialData?: any }) {
    const [submitLoading, setSubmitLoading] = useState<boolean>(false);
    const [printReceipt, setPrintReceipt] = useState<boolean>(true);
    const [emailReceipt, setEmailReceipt] = useState<boolean>(false);
    const [formData, setFormData] = useState({
      paymentMethod: 'Card',
      transactionId: '',
      cardType: '',
      lastFourDigits: '',
      notes: ''
    });

    // Get appointment data from initialData
    const appointment = initialData;

    // Handle form changes
    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => {
      const { name, value } = e.target;
      setFormData({ ...formData, [name]: value });
    };

    // Submit payment
    const handleSubmitPayment = async () => {
      try {
        setSubmitLoading(true);
        
        let paymentData: any = {
          paymentMethod: formData.paymentMethod,
          notes: formData.notes,
          receiptSent: emailReceipt
        };
        
        // Add appointment payment data
        paymentData = {
          ...paymentData,
          appointment: appointment._id,
          patient: appointment.patient.patientId, // This will use patientId (PAT-XXXX format)
          amount: parseFloat(appointment.type === 'Annual physical' ? '200.00' : 
                   appointment.type === 'Consultation' ? '150.00' : '100.00'),
          description: `Payment for ${appointment.type} appointment`,
          category: 'Appointment'
        };
        
        // Add payment method specific details
        if (formData.paymentMethod === 'Card') {
          if (!formData.transactionId) {
            alert('Please enter a transaction ID for card payments');
            setSubmitLoading(false);
            return;
          }
          
          paymentData.transactionId = formData.transactionId;
          paymentData.cardType = formData.cardType;
          paymentData.lastFourDigits = formData.lastFourDigits;
        }
        
        // Submit payment to the API
        const response = await fetch('/api/payments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(paymentData)
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to process payment');
        }
        
        const result = await response.json();
        
        // Show success message and close modal
        alert('Payment processed successfully!');
        onClose();
        
      } catch (error) {
        console.error('Error processing payment:', error);
        alert(`Payment failed: ${error.message}`);
      } finally {
        setSubmitLoading(false);
      }
    };

    if (!isOpen || !appointment) return null;

    return (
      <Modal 
        isOpen={isOpen} 
        onClose={onClose}
        title={`Process Payment - ${appointment.patient.name}`}
        footer={
          <>
            <Button variant="outline" onClick={onClose} disabled={submitLoading}>Cancel</Button>
            <Button variant="primary" onClick={handleSubmitPayment} disabled={submitLoading}>
              {submitLoading ? 'Processing...' : 'Complete Payment'}
            </Button>
          </>
        }
      >
        <div className="space-y-4">
          {/* Appointment Details */}
          <div className="bg-primary-50 p-4 rounded-md border border-primary-100 mb-4 dark:bg-primary-900/20 dark:border-primary-800">
            <div className="flex justify-between items-center mb-2">
              <h3 className="text-sm font-medium text-gray-700 dark:text-gray-300">Appointment Details</h3>
              <span className="bg-primary-100 text-primary-800 px-2 py-1 rounded-full text-xs font-medium dark:bg-primary-800 dark:text-primary-200">
                {appointment.type}
              </span>
            </div>
            <div className="grid grid-cols-2 gap-2 text-sm">
              <div>
                <p className="text-gray-500 dark:text-gray-400">Patient</p>
                <p className="font-medium">{appointment.patient.name}</p>
                <p className="text-xs text-gray-500">{appointment.patient.patientId}</p>
              </div>
              <div>
                <p className="text-gray-500 dark:text-gray-400">Date & Time</p>
                <p className="font-medium">
                  {new Date(appointment.date).toLocaleDateString()} at {appointment.time}
                </p>
              </div>
            </div>
          </div>

          {/* Payment Summary */}
          <div className="border rounded-md overflow-hidden dark:border-gray-700">
            <div className="bg-gray-50 dark:bg-gray-800 px-4 py-3 border-b dark:border-gray-700">
              <h3 className="text-sm font-medium text-gray-700 dark:text-gray-300">Payment Summary</h3>
            </div>
            <div className="p-4">
              <div className="space-y-2">
                <div className="flex justify-between">
                  <span className="text-sm text-gray-600 dark:text-gray-400">
                    {appointment.type} Fee
                  </span>
                  <span className="text-sm font-medium">
                    ${appointment.type === 'Annual physical' ? '200.00' : 
                      appointment.type === 'Consultation' ? '150.00' : '100.00'}
                  </span>
                </div>
                <div className="flex justify-between pt-2 border-t border-gray-200 dark:border-gray-700">
                  <span className="text-sm font-medium">Total Amount</span>
                  <span className="text-sm font-bold">
                    ${appointment.type === 'Annual physical' ? '200.00' : 
                      appointment.type === 'Consultation' ? '150.00' : '100.00'}
                  </span>
                </div>
              </div>
            </div>
          </div>

          {/* Payment Method Card */}
          <div className="border rounded-md overflow-hidden dark:border-gray-700 mt-4">
            <div className="bg-gray-50 dark:bg-gray-800 px-4 py-3 border-b dark:border-gray-700">
              <h3 className="text-sm font-medium text-gray-700 dark:text-gray-300">Payment Method</h3>
            </div>
            <div className="p-4">
              <div className="space-y-3">
                <div className="flex items-center">
                  <input
                    type="radio"
                    id="payment-pos"
                    name="paymentMethod"
                    value="Card"
                    checked={formData.paymentMethod === 'Card'}
                    onChange={handleChange}
                    className="h-4 w-4 text-primary-600 border-gray-300"
                  />
                  <label htmlFor="payment-pos" className="ml-2 text-sm text-gray-700 dark:text-gray-300">
                    POS Machine (Card Payment)
                  </label>
                </div>
                
                <div className="flex items-center">
                  <input
                    type="radio"
                    id="payment-cash"
                    name="paymentMethod"
                    value="Cash"
                    checked={formData.paymentMethod === 'Cash'}
                    onChange={handleChange}
                    className="h-4 w-4 text-primary-600 border-gray-300"
                  />
                  <label htmlFor="payment-cash" className="ml-2 text-sm text-gray-700 dark:text-gray-300">
                    Cash
                  </label>
                </div>
                
                <div className="flex items-center">
                  <input
                    type="radio"
                    id="payment-check"
                    name="paymentMethod"
                    value="Check"
                    checked={formData.paymentMethod === 'Check'}
                    onChange={handleChange}
                    className="h-4 w-4 text-primary-600 border-gray-300"
                  />
                  <label htmlFor="payment-check" className="ml-2 text-sm text-gray-700 dark:text-gray-300">
                    Check
                  </label>
                </div>
              </div>
            </div>
          </div>
          
          {/* POS Details Card - Only show if Card payment is selected */}
          {formData.paymentMethod === 'Card' && (
            <div className="border rounded-md overflow-hidden dark:border-gray-700 mt-4">
              <div className="bg-gray-50 dark:bg-gray-800 px-4 py-3 border-b dark:border-gray-700">
                <h3 className="text-sm font-medium text-gray-700 dark:text-gray-300">POS Transaction Details</h3>
              </div>
              <div className="p-4">
                <div className="space-y-3">
                  <div>
                    <label className="block text-sm text-gray-600 dark:text-gray-400 mb-1">
                      Transaction ID
                    </label>
                    <Input 
                      type="text"
                      placeholder="Enter POS transaction reference ID" 
                      name="transactionId"
                      value={formData.transactionId}
                      onChange={handleChange}
                    />
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-sm text-gray-600 dark:text-gray-400 mb-1">
                        Card Type
                      </label>
                      <select 
                        className="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200"
                        name="cardType"
                        value={formData.cardType}
                        onChange={handleChange}
                      >
                        <option value="">Select card type</option>
                        <option value="Visa">Visa</option>
                        <option value="Mastercard">Mastercard</option>
                        <option value="American Express">American Express</option>
                        <option value="Discover">Discover</option>
                        <option value="Other">Other</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm text-gray-600 dark:text-gray-400 mb-1">
                        Last 4 Digits
                      </label>
                      <Input 
                        type="text"
                        placeholder="xxxx" 
                        maxLength={4}
                        name="lastFourDigits"
                        value={formData.lastFourDigits}
                        onChange={handleChange}
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Receipt Options Card */}
          <div className="border rounded-md overflow-hidden dark:border-gray-700 mt-4">
            <div className="bg-gray-50 dark:bg-gray-800 px-4 py-3 border-b dark:border-gray-700">
              <h3 className="text-sm font-medium text-gray-700 dark:text-gray-300">Receipt Options</h3>
            </div>
            <div className="p-4">
              <div className="space-y-3">
                <div className="flex items-center">
                  <input
                    type="checkbox"
                    id="print-receipt"
                    className="h-4 w-4 text-primary-600 rounded border-gray-300"
                    checked={printReceipt}
                    onChange={(e) => setPrintReceipt(e.target.checked)}
                  />
                  <label htmlFor="print-receipt" className="ml-2 text-sm text-gray-700 dark:text-gray-300">
                    Print receipt for patient
                  </label>
                </div>
                <div className="flex items-center">
                  <input
                    type="checkbox"
                    id="email-receipt"
                    className="h-4 w-4 text-primary-600 rounded border-gray-300"
                    checked={emailReceipt}
                    onChange={(e) => setEmailReceipt(e.target.checked)}
                  />
                  <label htmlFor="email-receipt" className="ml-2 text-sm text-gray-700 dark:text-gray-300">
                    Email receipt to patient
                  </label>
                </div>
              </div>
            </div>
          </div>
          
          {/* Payment Notes Card */}
          <div className="border rounded-md overflow-hidden dark:border-gray-700 mt-4">
            <div className="bg-gray-50 dark:bg-gray-800 px-4 py-3 border-b dark:border-gray-700">
              <h3 className="text-sm font-medium text-gray-700 dark:text-gray-300">Payment Notes</h3>
            </div>
            <div className="p-4">
              <textarea 
                className="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200"
                rows={2}
                placeholder="Any additional payment notes"
                name="notes"
                value={formData.notes}
                onChange={handleChange}
              ></textarea>
            </div>
          </div>
        </div>
      </Modal>
    );
  }

  return (
    <ModalContext.Provider value={{ openModal, closeModal }}>
      <div className="modal-provider-container" data-modal-context="true" ref={(el) => {
        if (el) {
          // @ts-ignore - Attach modal functions to the DOM element for access from prescription modal
          el.__modalContext = modalContextRef.current;
        }
      }}>
        {children}
        
        {/* Render custom modals */}
        {isOpen && customModal && (
          <Modal
            isOpen={isOpen}
            onClose={closeModal}
            title={customModal.title}
            size={customModal.size as "sm" | "md" | "lg" | "xl" || "md"}
          >
            {customModal.content}
          </Modal>
        )}
        
        {/* Render standard modals */}
        {isOpen && modalType === 'newAppointment' && renderNewAppointmentModal()}
        {isOpen && modalType === 'newPrescription' && <NewPrescriptionModal isOpen={isOpen} onClose={closeModal} initialData={modalData} />}
        {isOpen && modalType === 'addPatient' && renderAddPatientModal()}
        {isOpen && modalType === 'addMedication' && renderAddMedicationModal()}
        {isOpen && modalType === 'viewCalendar' && renderViewCalendarModal()}
        {isOpen && modalType === 'viewPatientDetails' && renderPatientDetailsModal()}
        {isOpen && modalType === 'patientActions' && renderPatientActionsModal()}
        {isOpen && modalType === 'processPayment' && <ProcessPaymentModal isOpen={isOpen} onClose={closeModal} />}
        {isOpen && modalType === 'appointmentPayment' && <AppointmentPaymentModal isOpen={isOpen} onClose={closeModal} initialData={modalData} />}
        {isOpen && modalType === 'viewInvoice' && <ViewInvoiceModal isOpen={isOpen} onClose={closeModal} initialData={modalData} />}
      </div>
    </ModalContext.Provider>
  );
} 